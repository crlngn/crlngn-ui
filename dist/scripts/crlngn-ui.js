var Za=Object.defineProperty;var ga=i=>{throw TypeError(i)};var Qa=(i,e,t)=>e in i?Za(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var h=(i,e,t)=>Qa(i,typeof e!="symbol"?e+"":e,t),An=(i,e,t)=>e.has(i)||ga("Cannot "+t);var m=(i,e,t)=>(An(i,e,"read from private field"),t?t.call(i):e.get(i)),T=(i,e,t)=>e.has(i)?ga("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(i):e.set(i,t),k=(i,e,t,n)=>(An(i,e,"write to private field"),n?n.call(i,t):e.set(i,t),t),ne=(i,e,t)=>(An(i,e,"access private method"),t);var fa=(i,e,t,n)=>({set _(a){k(i,e,a,t)},get _(){return m(i,e,n)}});const A={INIT:"init",READY:"ready",CANVAS_READY:"canvasReady",CANVAS_INIT:"canvasInit",RENDER_CHAT_MESSAGE:"renderChatMessageHTML",GET_SCENE_CONTROLS:"getSceneControlButtons",RENDER_SCENE_CONTROLS:"renderSceneControls",RENDER_PLAYERS_LIST:"renderPlayers",ACTIVATE_SCENE_CONTROLS:"activateSceneControls",RENDER_SCENE_NAV:"renderSceneNavigation",COLLAPSE_SCENE_NAV:"collapseSceneNavigation",EXPAND_SCENE_NAV:"expandSceneNavigation",GET_SCENE_NAV_CONTEXT:"getSceneNavigationContext",RENDER_SCENE:"renderScene",RENDER_DOCUMENT_DIRECTORY:"renderDocumentDirectory",GET_SCENE_DIRECTORY_ENTRY_CONTEXT:"getSceneDirectoryEntryContext",RENDER_SCENE_DIRECTORY:"renderSceneDirectory",CREATE_FOLDER:"createFolder",UPDATE_FOLDER:"updateFolder",DELETE_FOLDER:"deleteFolder",CREATE_SCENE:"createScene",UPDATE_SCENE:"updateScene",DELETE_SCENE:"deleteScene",COLLAPSE_SIDE_BAR:"collapseSidebar",EXPAND_SIDE_BAR:"expandSidebar",RENDER_SIDE_BAR:"renderSidebar",ACTIVATE_CHAT_LOG:"activateChatLog",ACTIVATE_CHAT_LOG_5E:"activateChatLog5e",RENDER_HOTBAR:"renderHotbar",RENDER_CAMERA_VIEWS:"renderCameraViews",WEBRTC_USER_STATE_CHANGED:"webrtcUserStateChanged",WEBRTC_SETTINGS_CHANGED:"webrtcSettingsChanged",RTC_SETTINGS_CHANGED:"rtcSettingsChanged",RTC_MODE_CHANGED:"rtcModeChanged",RTC_VOICE_SETTINGS_CHANGED:"rtcVoiceSettingsChanged",RTC_LOCAL_STREAM_ESTABLISHED:"rtcLocalStreamEstablished",RTC_LOCAL_STREAM_ERROR:"rtcLocalStreamError",RTC_PEER_CONNECTED:"rtcPeerConnected",RTC_PEER_DISCONNECTED:"rtcPeerDisconnected",RTC_PEER_ERROR:"rtcPeerError",RTC_SIGNALING_EVENT:"rtcSignalingEvent",RENDER_AV_CONFIG:"renderAVConfig",RENDER_AV_MASTER:"renderAVMaster",RENDER_AV_CLIENT:"renderAVClient",USER_CONNECTED:"userConnected",USER_DISCONNECTED:"userDisconnected",UPDATE_USER:"updateUser",UPDATE_DOCUMENT:"updateDocument",UPDATE_SETTING:"updateSetting",CLIENT_SETTING_CHANGED:"clientSettingChanged",RENDER_TOKEN_HUD:"renderTokenHUD",RENDER_ACTOR_SHEET:"renderActorSheetV2",RENDER_ITEM_SHEET:"renderItemSheetV2",RENDER_COMPENDIUM_BROWSER:"renderCompendiumBrowser"},z="crlngn-ui",on=["%cCarolingian UI","color:rgb(107, 72, 149); font-weight: bold;","|"],_a=`
  --background: var(--color-dark-bg-90) !important;
  --filigree-background-color: var(--color-dark-bg-10) !important;
  --dnd5e-border-dotted: var(--color-dark-bg) !important;
  --dnd5e-color-gold: rgba(159, 146, 117, 0.4) !important;
  --input-background-color: var(--color-cool-4) !important;
  --chat-dark-blue: rgba(24, 32, 38, 1) !important;
  --input-background-alt: var(--color-dark-bg-50) !important;
  --color-text-secondary: var(--color-light-1) !important;
  --color-text-primary: var(--color-light-1) !important;
  --button-text-color: var(--color-light-1) !important;
  --color-border-light-1: var(--dnd5e-color-gold) !important;

  --crlngn-button-bg: rgba(15, 15, 15, 0.15) !important;
  --color-bg-button: rgba(40, 47, 54, 1) !important;
  --dnd5e-border-groove: 1px solid rgba(36, 36, 36, 0.35) !important;
  --dnd5e-color-groove: var(--dnd5e-color-gold) !important;
  --dnd5e-sheet-bg: rgb(37, 40, 48) !important;
  --sidebar-background: var(--control-bg-color, var(--color-cool-5-90)) !important;
  --dnd5e-color-parchment: rgb(40, 47, 54) !important;
  --dnd5e-background-card: rgb(40, 47, 54) !important; 
  --dnd5e-background-parchment: rgb(40, 47, 54) !important;

  --color-pf-alternate: rgba(82, 107, 120, 0.44) !important;
  --color-text-gray-blue: rgb(168, 180, 188, 1) !important;
  --color-text-gray-blue-b: rgb(138, 155, 168, 1) !important;
  --chat-button-bg: rgba(40, 47, 54, 1) !important;
  --chat-button-bg-15: rgba(40, 47, 54, 0.15) !important;
  --chat-button-bg-25: rgba(40, 47, 54, 0.25) !important;
  --chat-button-bg-50: rgba(40, 47, 54, 0.5) !important;
  --chat-button-bg-75: rgba(40, 47, 54, 0.75) !important;
  --chat-dark-blue: rgba(24, 32, 38, 1) !important;
  --chat-dark-blue-b: rgb(29, 36, 48, 1) !important; 
  --chat-dark-bg: rgba(40, 47, 54, 1) !important; 
  --chat-dark-bg-15: rgba(40, 47, 54, 0.15) !important;
  --chat-dark-bg-25: rgba(40, 47, 54, 0.25) !important;
  --chat-dark-bg-50: rgba(40, 47, 54, 0.50) !important; 
  --chat-dark-bg-75: rgba(40, 47, 54, 0.75) !important; 
  --chat-dark-bg-90: rgba(40, 47, 54, 0.90) !important; 

  --color-input-bg: var(--color-dark-bg-50) !important; 

  --color-button-bg: rgba(90,120,150,0.5) !important;
  --color-input-border: rgba(90,120,150, 0.5) !important;
  --color-border-dark-5: rgba(80, 80, 80, 1) !important;
  --color-sidebar-font: rgba(213, 221, 230, 0.8) !important;

  --color-text-dark: rgba(235,235,235,1) !important;
  --color-text-dark-op: rgba(235,235,235,0.6) !important;
  --color-text-light: rgba(235,235,235,1) !important;
  --input-background-alt: var(--color-cool-5) !important;
  --color-text-secondary:var(--color-light-3) !important;
  --color-text-primary: var(--color-light-1) !important;

  --color-text-dark-primary: var(--color-light-1) !important;

  background: var(--color-dark-bg-90) !important;
  color: var(--color-light-1) !important;

  p, a, span, div, aside, section, table, td, tr, th, h1, h2, h3, h4, h5, h6, ul, ol, li, i, b, strong, u{
    color: var(--color-light-1) !important;
    background: transparent !important;
  }

  .window-header,
  header, footer {
    background: var(--color-dark-bg-90) !important;
    color: var(--color-light-1) !important;
  }
  
  .window-content {
    background: var(--color-dark-bg-25) !important;
    color: var(--color-light-1) !important;
  }

  .window-header{
    border-bottom: 1px solid var(--color-cool-4) !important;
  }

  button{
    color: var(--color-light-1) !important;
    &:hover{
      background-color: var(--color-warm-2) !important;
    }
  }
`,Cn=class Cn{static log(e="",t=[],n=!1){try{const a=Cn.debugOn;if(!(n||a))return;console.log(...on,e,...t)}catch{console.log(...on,e,...t)}}static warn(e="",t=[]){console.warn(...on,e,...t)}static error(e,t){var n;t.ui&&((n=ui.notifications)==null||n.error(e,{localize:!0,permanent:t.permanent})),t.console&&console.error(...on,e)}};h(Cn,"debugOn",!1);let f=Cn;const pa={select:"select",checkbox:"checkbox",text:"text",number:"number"},v={client:"client",world:"world"},Rt={small:{name:"small",size:"36px"},regular:{name:"regular",size:"42px"},large:{name:"large",size:"48px"}},St={playerColor:{name:"playerColor"},rollType:{name:"rollType"},none:{name:"none"}},ke={off:{name:"OFF"},horizontal:{name:"horizontal"},vertical:{name:"vertical"}},Gn=140,Ke=[{label:"Carolingian Teal",className:"crlngn-theme",colorPreview:["rgb(62, 62, 88)","rgb(68, 147, 173)"]},{label:"Gold and Chocolate",className:"crlngn-theme-gold-chocolate",colorPreview:["rgb(34, 25, 25)","rgb(164, 138, 51)"]},{label:"Royal Blood",className:"crlngn-theme-royal-blood",colorPreview:["rgb(40, 31, 49)","rgb(127, 18, 36)"]},{label:"Dark Sorcery",className:"crlngn-theme-dark-sorcery",colorPreview:["rgb(31, 47, 49)","rgb(130, 110, 160)"]},{label:"Pumpkin Patch",className:"crlngn-theme-pumpkin-patch",colorPreview:["rgb(40, 31, 49)","rgb(220, 120, 43)"]},{label:"Gambit's Blue",className:"crlngn-theme-gambits-blue",colorPreview:["rgb(40, 31, 49)","rgb(45, 126, 207)"]}];function w(){return{moduleSettingsMenu:{isMenu:!0,showOnRoot:!0,tag:"v2-interface-options-menu",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.label"),hint:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.hint"),propType:Object,scope:v.client,config:!1,requiresReload:!1,fields:[],default:{}},interfaceOptionsMenu:{isMenu:!0,showOnRoot:!1,tag:"v2-interface-options-menu",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.label"),hint:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.hint"),propType:Object,fields:["sceneControlsFadeOut","sidebarTabsFadeOut","chatLogControlsFadeOut","playerListFadeOut","cameraDockFadeOut","macroHotbarFadeOut","sceneNavFadeOut","sceneControlsHide","sidebarTabsHide","chatLogControlsHide","playerListHide","cameraDockHide","macroHotbarHide","sceneNavHide","enableSceneControls","enableSidebarTabs","enableChatLogControls","sceneNavEnabled","enableMacroLayout","enableFloatingDock","enablePlayerList","collapseMacroBar","useFolderStyle","controlsAutoHide"],default:{sceneControlsFadeOut:!1,sidebarTabsFadeOut:!1,chatLogControlsFadeOut:!0,playerListFadeOut:!0,cameraDockFadeOut:!1,macroHotbarFadeOut:!0,sceneNavFadeOut:!1,sceneControlsHide:!1,sidebarTabsHide:!1,chatLogControlsHide:!1,playerListHide:!1,cameraDockHide:!1,macroHotbarHide:!1,sceneNavHide:!1,enableSceneControls:!0,enableSidebarTabs:!0,enableChatLogControls:!0,sceneNavEnabled:!0,enableMacroLayout:!0,enableFloatingDock:!0,enablePlayerList:!0,collapseMacroBar:!1,useFolderStyle:!0,controlsAutoHide:!1},scope:v.client,config:!1,requiresReload:!1},customFontsMenu:{tag:"v2-custom-font-families",label:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.label"),title:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.title"),hint:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.hint"),description:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.description"),propType:Object,fields:["uiFontBody","uiFontTitles","journalFontBody","journalFontTitles"],default:{uiFontBody:'"Work Sans", Arial, sans-serif',uiFontTitles:'"Roboto Slab", Arial, sans-serif',journalFontBody:'"Work Sans", Arial, sans-serif',journalFontTitles:'"Roboto Slab", Arial, sans-serif'},scope:v.world,config:!1,requiresReload:!1},themeAndStylesMenu:{isMenu:!0,showOnRoot:!1,tag:"v2-theme-styles-menu",label:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.label"),title:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.title"),hint:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.hint"),propType:String,fields:["colorTheme","adjustOtherModules","otherModulesList","forcedDarkTheme","customStyles","useHorizontalSheetTabs","applyThemeToSheets"],default:{colorTheme:"crlngn-theme",adjustOtherModules:!0,otherModulesList:"'combat-carousel','dice-tray','hurry-up','crux','fvtt-youtube-player','bg3-inspired-hotbar','touch-vtt','breaktime', 'simple-timekeeping'",forcedDarkTheme:"",customStyles:"",useHorizontalSheetTabs:!0,applyThemeToSheets:!0},scope:v.world,config:!1,requiresReload:!1},chatMessagesMenu:{isMenu:!0,showOnRoot:!1,tag:"v2-chat-messages-menu",label:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.label"),hint:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.hint"),propType:Object,fields:["sideBarWidth","enableChatStyles","chatBorderColor","useLeftChatBorder"],default:{sideBarWidth:300,enableChatStyles:!0,chatBorderColor:St.playerColor.name,useLeftChatBorder:!0},scope:v.client,config:!1,requiresReload:!1},leftControlsMenu:{isMenu:!0,showOnRoot:!1,tag:"v2-left-controls-menu",label:game.i18n.localize("CRLNGN_UI.settings.leftControlsMenu.label"),hint:game.i18n.localize("CRLNGN_UI.settings.leftControlsMenu.hint"),propType:Object,fields:["controlsAutoHide"],default:{controlsAutoHide:!1},scope:v.client,config:!1,requiresReload:!1},playersListMenu:{isMenu:!0,showOnRoot:!1,tag:"v2-players-list-menu",label:game.i18n.localize("CRLNGN_UI.settings.playersListMenu.label"),hint:game.i18n.localize("CRLNGN_UI.settings.playersListMenu.hint"),propType:Object,fields:["autoHidePlayerList","playerListAvatars"],default:{autoHidePlayerList:!1,playerListAvatars:!0},scope:v.client,config:!1,requiresReload:!1},sheets5eMenu:{isMenu:!0,showOnRoot:!1,tag:"v2-sheets-5e-menu",label:game.i18n.localize("CRLNGN_UI.settings.sheets5eMenu.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sheets5eMenu.hint"),propType:Object,fields:["applyThemeToSheets","useHorizontalSheetTabs"],default:{applyThemeToSheets:!0,useHorizontalSheetTabs:!0},scope:v.client,config:!1,requiresReload:!1},cameraDockMenu:{isMenu:!0,showOnRoot:!1,tag:"v2-camera-dock-menu",label:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.label"),hint:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.hint"),propType:Object,fields:["dockResizeOnUserJoin","dockPosX","dockPosY","dockWidth","dockHeight","defaultVideoWidth"],default:{dockResizeOnUserJoin:ke.horizontal.name,defaultVideoWidth:160,dockPosX:0,dockPosY:120,dockWidth:160,dockHeight:140},scope:v.client,config:!1,requiresReload:!1},sceneNavMenu:{isMenu:!0,showOnRoot:!1,tag:"v2-scene-nav-menu",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.hint"),propType:Object,fields:["useSceneFolders","navShowRootFolders","useSceneLookup","sceneClickToView","useSceneIcons","navStartCollapsed","showNavOnHover","sceneItemWidth","useSceneBackButton","useScenePreview","hideInactiveOnFolderToggle"],default:{useSceneFolders:!0,navStartCollapsed:!1,sceneClickToView:!0,useSceneIcons:!0,navShowRootFolders:!1,useSceneLookup:!0,showNavOnHover:!1,sceneItemWidth:150,useScenePreview:!0,useSceneBackButton:!0,hideInactiveOnFolderToggle:!0},scope:v.client,config:!1,requiresReload:!1},enforceGMSettings:{tag:"v2-enforce-gm-settings",label:game.i18n.localize("CRLNGN_UI.settings.enforceGMSettings.label"),hint:game.i18n.localize("CRLNGN_UI.settings.enforceGMSettings.hint"),propType:Boolean,default:!1,scope:v.world,config:!0,requiresReload:!0},defaultSettings:{tag:"v2-default-settings",label:game.i18n.localize("CRLNGN_UI.settings.defaultSettings.label"),hint:game.i18n.localize("CRLNGN_UI.settings.defaultSettings.hint"),propType:Object,default:{},scope:v.world,config:!1,requiresReload:!1},disableUI:{tag:"disable-ui",label:game.i18n.localize("CRLNGN_UI.settings.disableUI.label"),hint:game.i18n.localize("CRLNGN_UI.settings.disableUI.hint"),propType:Boolean,scope:v.client,config:!0,default:!1,requiresReload:!1},useSceneFolders:{tag:"v2-nav-folders-enabled",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useSceneFolders.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useSceneFolders.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},navFoldersForPlayers:{tag:"v2-nav-folders-for-players",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.navFoldersForPlayers.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.navFoldersForPlayers.hint"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},navStartCollapsed:{tag:"v2-nav-start-collapsed",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.navStartCollapsed.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.navStartCollapsed.hint"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},navShowRootFolders:{tag:"v2-nav-show-root-folders",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.navShowRootFolders.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.navShowRootFolders.hint"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},hideInactiveOnFolderToggle:{tag:"v2-hide-inactive-on-folder-toggle",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.hideInactiveOnFolderToggle.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.hideInactiveOnFolderToggle.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},useSceneLookup:{tag:"v2-use-scene-lookup",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useSceneLookup.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useSceneLookup.hint"),propType:Boolean,default:!0,scope:v.world,config:!1,requiresReload:!1},sceneItemWidth:{tag:"v2-scene-nav-item-width",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.sceneItemWidth.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.sceneItemWidth.hint"),propType:Number,inputType:pa.number,default:150,scope:v.client,config:!1},showNavOnHover:{tag:"v2-show-nav-on-hover",oldName:"showNavOnHover",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.showNavOnHover.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.showNavOnHover.hint"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},sceneClickToView:{tag:"v2-scene-click-to-view",oldName:"sceneClickToView",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.sceneClickToView.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.sceneClickToView.hint"),propType:Boolean,default:!0,scope:v.world,config:!1,requiresReload:!1},useSceneIcons:{tag:"v2-use-scene-icons",oldName:"useSceneIcons",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useSceneIcons.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useSceneIcons.hint"),propType:Boolean,default:!0,scope:v.world,config:!1,requiresReload:!1},useSceneBackButton:{tag:"v2-use-scene-back-button",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useSceneBackButton.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useSceneBackButton.hint"),propType:Boolean,default:!0,scope:v.world,config:!1,requiresReload:!1},useScenePreview:{tag:"v2-use-scene-preview",oldName:"useScenePreview",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useScenePreview.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.useScenePreview.hint"),propType:Boolean,default:!0,scope:v.world,config:!1,requiresReload:!1},sceneNavCollapsed:{tag:"v2-scene-nav-collapsed",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavCollapsed.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavCollapsed.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},sceneNavPos:{tag:"v2-scene-nav-pos",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavPos.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavPos.hint"),propType:Number,default:0,scope:v.client,config:!1,requiresReload:!1},collapseMacroBar:{tag:"v2-collapse-macro-bar",label:game.i18n.localize("CRLNGN_UI.settings.collapseMacroBar.label"),hint:game.i18n.localize("CRLNGN_UI.settings.collapseMacroBar.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},useFolderStyle:{tag:"v2-use-folder-style",label:game.i18n.localize("CRLNGN_UI.settings.useFolderStyle.label"),hint:game.i18n.localize("CRLNGN_UI.settings.useFolderStyle.hint"),propType:Boolean,default:!0,scope:v.world,config:!1,requiresReload:!1},debugMode:{tag:"v2-debug-mode",label:game.i18n.localize("CRLNGN_UI.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN_UI.settings.debugMode.hint"),propType:Boolean,default:!1,scope:v.client,config:!0,requiresReload:!1},autoHidePlayerList:{tag:"v2-auto-hide-player-list",label:game.i18n.localize("CRLNGN_UI.settings.playersListMenu.fields.autoHidePlayerList.label"),hint:game.i18n.localize("CRLNGN_UI.settings.playersListMenu.fields.autoHidePlayerList.hint"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},playerListAvatars:{tag:"v2-player-list-avatars",label:game.i18n.localize("CRLNGN_UI.settings.playersListMenu.fields.playerListAvatars.label"),hint:game.i18n.localize("CRLNGN_UI.settings.playersListMenu.fields.playerListAvatars.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},uiFontBody:{tag:"v2-ui-font-body",oldName:"uiFont",label:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.fields.uiBody.label"),hint:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.fields.uiBody.hint"),propType:String,default:'"Work Sans", Arial, sans-serif',scope:v.world,config:!1,requiresReload:!1},uiFontTitles:{tag:"v2-ui-font-titles",oldName:"uiTitles",label:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.fields.uiTitles.label"),hint:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.fields.uiTitles.hint"),propType:String,default:'"Roboto Slab", Arial, sans-serif',scope:v.world,config:!1,requiresReload:!1},journalFontBody:{tag:"v2-journal-font-body",oldName:"journalBody",label:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.fields.journalBody.label"),hint:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.fields.journalBody.hint"),propType:String,default:'"Work Sans", Arial, sans-serif',scope:v.world,config:!1,requiresReload:!1},journalFontTitles:{tag:"v2-journal-font-titles",oldName:"journalTitles",label:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.fields.journalTitles.label"),hint:game.i18n.localize("CRLNGN_UI.settings.customFontsMenu.fields.journalTitles.hint"),propType:String,default:'"Roboto Slab", Arial, sans-serif',scope:v.world,config:!1,requiresReload:!1},colorTheme:{tag:"v2-color-theme",label:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.colorTheme.label"),hint:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.colorTheme.hint"),propType:String,default:"crlngn-theme",scope:v.world,config:!1,requiresReload:!1},adjustOtherModules:{tag:"v2-adjust-other-modules",label:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.adjustOtherModules.label"),hint:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.adjustOtherModules.hint"),propType:Boolean,default:!0,scope:v.world,config:!1,requiresReload:!1},otherModulesList:{tag:"v2-other-modules-list-a2",label:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.otherModulesList.label"),hint:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.otherModulesList.hint"),propType:String,default:"'combat-carousel','dice-tray','hurry-up','crux','fvtt-youtube-player','bg3-inspired-hotbar','touch-vtt','breaktime'",options:{"BG3 Inspired Hotbar":"'bg3-inspired-hotbar'",Breaktime:"'breaktime'","Combat Carousel":"'combat-carousel'",Crux:"'crux'","Dice Tray":"'dice-tray'","Hurry Up":"'hurry-up'","Simple Timekeeping & Calendar":"'simple-timekeeping'","Touch VTT":"'touch-vtt'","Youtube Player":"'fvtt-youtube-player'"},scope:v.world,config:!1,requiresReload:!1},customStyles:{tag:"v2-custom-styles",label:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.customStyles.label"),hint:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.customStyles.hint"),propType:String,default:"",scope:v.world,config:!1,requiresReload:!0},forcedDarkTheme:{tag:"v2-forced-dark-theme",label:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.forcedDarkTheme.label"),hint:game.i18n.localize("CRLNGN_UI.settings.themeAndStylesMenu.fields.forcedDarkTheme.hint"),propType:String,default:"",scope:v.world,config:!1,requiresReload:!1},chatBorderColor:{tag:"v2-chat-border-color",oldName:"borderColor",label:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.borderColor.label"),hint:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.borderColor.hint"),options:{playerColor:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.borderColor.options.playerColor"),rollType:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.borderColor.options.rollType"),none:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.borderColor.options.none")},propType:String,default:St.playerColor.name,scope:v.client,config:!1,requiresReload:!0},useLeftChatBorder:{tag:"v2-use-left-chat-border",label:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.useLeftChatBorder.label"),hint:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.useLeftChatBorder.hint"),propType:Boolean,inputType:pa.checkbox,default:!0,scope:v.client,config:!1,requiresReload:!0},enableChatStyles:{tag:"v2-enable-chat-styles",oldName:"enableChatStyles",label:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.enableChatStyles.label"),hint:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.enableChatStyles.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!0},sideBarWidth:{tag:"v2-side-bar-width",label:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.sideBarWidth.label"),hint:game.i18n.localize("CRLNGN_UI.settings.chatMessagesMenu.fields.sideBarWidth.hint"),propType:Number,default:300,scope:v.client,config:!1,requiresReload:!1},controlsAutoHide:{tag:"v2-auto-hide-secondary-controls",oldName:"autoHideSecondary",label:game.i18n.localize("CRLNGN_UI.settings.leftControlsMenu.fields.autoHideSecondary.label"),hint:game.i18n.localize("CRLNGN_UI.settings.leftControlsMenu.fields.autoHideSecondary.hint"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},dockPosX:{tag:"v2-camera-dock-x",label:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockPosX.label"),hint:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockPosX.hint"),propType:Number,default:0,scope:v.client,config:!1,requiresReload:!1},dockPosY:{tag:"v2-camera-dock-y",label:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockPosY.label"),hint:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockPosY.hint"),propType:Number,default:120,scope:v.client,config:!1,requiresReload:!1},dockWidth:{tag:"v2-camera-dock-width",label:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockWidth.label"),hint:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockWidth.hint"),propType:Number,default:160,scope:v.client,config:!1,requiresReload:!1},dockHeight:{tag:"v2-camera-dock-height",label:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockHeight.label"),hint:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockHeight.hint"),propType:Number,default:145,scope:v.client,config:!1,requiresReload:!1},dockResizeOnUserJoin:{tag:"v2-dock-resize-on-user-join",label:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockResizeOnUserJoin.label"),hint:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockResizeOnUserJoin.hint"),options:{off:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockResizeOnUserJoin.options.off"),horizontal:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockResizeOnUserJoin.options.horizontal"),vertical:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.dockResizeOnUserJoin.options.vertical")},propType:String,default:ke.horizontal.name,scope:v.client,config:!1,requiresReload:!1},defaultVideoWidth:{tag:"v2-default-video-width",label:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.defaultVideoWidth.label"),hint:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.defaultVideoWidth.hint"),propType:Number,default:160,scope:v.client,config:!1,requiresReload:!1},lastUpdateId:{tag:"last-update-id",label:game.i18n.localize("CRLNGN_UI.ui.updates.label"),hint:game.i18n.localize("CRLNGN_UI.ui.updates.hint"),propType:String,scope:v.world,config:!1,default:"",requiresReload:!1},sceneControlsFadeOut:{tag:"v2-scene-controls-fade-out",oldName:"sceneControlsFadeOut",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.sceneControls"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},sidebarTabsFadeOut:{tag:"v2-sidebar-tabs-fade-out",oldName:"sidebarTabsFadeOut",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.sidebarTabs"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},chatLogControlsFadeOut:{tag:"v2-chat-log-controls-fade-out",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.chatLogControls"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},playerListFadeOut:{tag:"v2-player-list-fade-out",oldName:"playerListFadeOut",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.playerList"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},cameraDockFadeOut:{tag:"v2-camera-fade-out",oldName:"cameraDockFadeOut",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.cameraDock"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},macroHotbarFadeOut:{tag:"v2-macro-hotbar-fade-out",oldName:"macroHotbarFadeOut",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.macroHotbar"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},sceneNavFadeOut:{tag:"v2-scene-nav-fade-out",oldName:"sceneNavFadeOut",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.sceneNav"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},sceneControlsHide:{tag:"v2-scene-controls-hide",oldName:"sceneControlsHide",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.sceneControls"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},sidebarTabsHide:{tag:"v2-sidebar-tabs-hide",oldName:"sidebarTabsHide",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.sidebarTabs"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},chatLogControlsHide:{tag:"v2-chat-log-controls-hide",oldName:"chatLogControlsHide",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.chatLogControls"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},playerListHide:{tag:"v2-player-list-hide",oldName:"playerListHide",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.playerList"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},cameraDockHide:{tag:"v2-camera-dock-hide",oldName:"cameraDockHide",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.cameraDock"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},macroHotbarHide:{tag:"v2-macro-hotbar-hide",oldName:"macroHotbarHide",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.macroHotbar"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},sceneNavHide:{tag:"v2-scene-nav-hide",oldName:"sceneNavHide",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.sceneNav"),propType:Boolean,default:!1,scope:v.client,config:!1,requiresReload:!1},sceneNavEnabled:{tag:"v2-scene-nav-enabled",label:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.sceneNavEnabled.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sceneNavMenu.fields.sceneNavEnabled.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!0},enableSceneControls:{tag:"v2-enable-scene-controls",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.sceneControls"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},enableSidebarTabs:{tag:"v2-enable-sidebar-tabs",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.sidebarTabs"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},enableChatLogControls:{tag:"v2-enable-chat-log-controls",label:game.i18n.localize("CRLNGN_UI.settings.interfaceOptionsMenu.fields.chatLogControls"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},enableMacroLayout:{tag:"v2-enable-macro-layout",label:game.i18n.localize("CRLNGN_UI.settings.enableMacroLayout.label"),hint:game.i18n.localize("CRLNGN_UI.settings.enableMacroLayout.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},enablePlayerList:{tag:"v2-enable-player-list",label:game.i18n.localize("CRLNGN_UI.settings.enablePlayerList.label"),hint:game.i18n.localize("CRLNGN_UI.settings.enablePlayerList.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1},enableFloatingDock:{tag:"v2-enable-floating-dock",label:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.enableFloatingDock.label"),hint:game.i18n.localize("CRLNGN_UI.settings.cameraDockMenu.fields.enableFloatingDock.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!0},applyThemeToSheets:{tag:"v2-apply-theme-and-styles",label:game.i18n.localize("CRLNGN_UI.settings.sheets5eMenu.fields.applyThemeToSheets.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sheets5eMenu.fields.applyThemeToSheets.hint"),propType:Boolean,default:!0,scope:v.world,config:!1,requiresReload:!1},useHorizontalSheetTabs:{tag:"v2-use-horizontal-tabs",label:game.i18n.localize("CRLNGN_UI.settings.sheets5eMenu.fields.useHorizontalSheetTabs.label"),hint:game.i18n.localize("CRLNGN_UI.settings.sheets5eMenu.fields.useHorizontalSheetTabs.hint"),propType:Boolean,default:!0,scope:v.client,config:!1,requiresReload:!1}}}const Gt=class Gt{static isModuleOn(e){var n;const t=(n=game.modules)==null?void 0:n.get(e);return!!(t!=null&&t.active)}static html(e,t){return e.querySelector(t)}static getFullWidth(e){return window.getComputedStyle(e).width==="0px"?0:e.offsetWidth}static getOffsetBottom(e){const t=e.offsetTop,n=e.offsetHeight,a=e.offsetParent;return(a?a.clientHeight:window.innerHeight)-(t+n)}static async processStyleSheetRules(e,t){var n;try{if(((n=e.ownerNode)==null?void 0:n.tagName)==="STYLE"){const a=e.ownerNode.textContent;this.extractFontsFromCSSText(a,t)}try{const a=e.cssRules||e.rules;if(!a)return;for(let o=0;o<a.length;o++){const s=a[o];if(s instanceof CSSFontFaceRule){const r=s.style.getPropertyValue("font-family");r&&(t.add(r),f.log("Found font-face rule:",[r]))}else if(s instanceof CSSImportRule){if(f.log("Found import rule:",[s.href]),s.styleSheet)await this.processStyleSheetRules(s.styleSheet,t);else if(s.href)try{const c=await(await fetch(s.href)).text();this.extractFontsFromCSSText(c,t)}catch(r){f.warn("Error fetching imported CSS:",[r])}}}}catch(a){if(a.name==="SecurityError"&&e.href){f.log("Security restriction on stylesheet, trying to fetch directly:",[e.href]);try{const s=await(await fetch(e.href)).text();this.extractFontsFromCSSText(s,t)}catch(o){f.warn("Error fetching cross-origin stylesheet:",[o])}}else f.warn("Error accessing CSS rules:",[a])}}catch(a){f.warn("Error in processStyleSheetRules:",[a])}}static extractFontsFromCSSText(e,t){if(!e)return;const n=/@font-face\s*{[^}]*font-family\s*:\s*(['"])(.+?)\1[^}]*}/gs,a=e.match(n)||[];f.log("Font face matches in CSS text:",[a.length]),a.forEach(o=>{const s=/font-family\s*:\s*(['"])(.+?)\1/,r=o.match(s);if(r&&r[2]){const c=r[2].trim();t.add(c),f.log("Found font-face in CSS text:",[c])}})}static getOffsetBottom(e){const t=e.offsetTop,n=e.offsetHeight;return f.log("getOffsetBottom",[t,n,window.innerHeight]),window.innerHeight-(t+n)}static async getAllFonts(){const e=new Set(Object.keys(CONFIG.fontDefinitions)),t=game.settings.get("core","fonts")||{},n=Object.entries(t).map(([s])=>s),a=await this.processStyleSheets();return f.log("Found fonts:",[{foundry:Array.from(e),custom:n,cssImported:Array.from(a)}]),Array.from(new Set([...e,...n,...a])).filter(s=>!/FontAwesome|Font Awesome|FoundryVTT/.test(s)).map(s=>s.replace(/['"]/g,"").trim()).sort((s,r)=>s.toLowerCase().localeCompare(r.toLowerCase()))||[]}static addCSSVars(e,t){let n=document.querySelector("#crlngn-ui-vars");if(!n){const y=document.querySelector("body.crlngn-ui");if(!y)return;n=document.createElement("style"),n.id="crlngn-ui-vars",n.textContent=`body.crlngn-ui {
}
`,y.prepend(n)}let a=n.textContent,o=a.indexOf("body.crlngn-ui {"),s=a.indexOf("}",o);o===-1&&(a=`body.crlngn-ui {
}
`,o=0,s=a.indexOf("}"));const c=a.substring(o+16,s).split(";").map(y=>y.trim()).filter(y=>y!==""),d={};c.forEach(y=>{const C=y.split(":");if(C.length>=2){const L=C[0].trim(),O=C.slice(1).join(":").trim();L&&(d[L]=O)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),d[e]=t;const g=Object.entries(d).map(([y,C])=>`  ${y}: ${C};`).join(`
`),p=a.substring(0,o)+`body.crlngn-ui {
`+g+`
}`+a.substring(s+1);n.textContent=p}static addCustomCSS(e,t="crlngn-ui-custom-css",n=!0){if(!e)return;let a=document.querySelector("#"+t);a||(a=document.createElement("style"),a.id=t,a.textContent="",document.head.appendChild(a));const o=/@import\s+(?:url\()?\s*['"]?[^'")]+['"]?\s*\)?\s*;/g,s=[];let r=e,c;for(;(c=o.exec(e))!==null;)s.push(c[0]);if(r=e.replace(o,"").trim(),!n){a.textContent=s.join(`
`)+(s.length?`

`:"")+r;return}if(!a.textContent.includes(r)){const d=a.textContent,g=[];let p;for(;(p=o.exec(d))!==null;)g.push(p[0]);const y=d.replace(o,"").trim(),C=s.filter(O=>!g.includes(O)),L=[...g,...C];a.textContent=L.join(`
`)+(L.length?`

`:"")+y+(y&&r?`

`:"")+r}}static smoothScrollTo(e,t,n="horizontal",a=300,o=null){const s=e.dataset.scrollAnimationId;s&&cancelAnimationFrame(Number(s));const r=n==="horizontal",c=r?e.scrollLeft:e.scrollTop,d=t-c;if(d===0)return o&&o(),null;const g=performance.now(),p=C=>{const L=C-g;if(L>=a){r?e.scrollLeft=t:e.scrollTop=t,delete e.dataset.scrollAnimationId,o&&o();return}const O=L/a,$=O<.5?2*O*O:1-Math.pow(-2*O+2,2)/2;r?e.scrollLeft=c+d*$:e.scrollTop=c+d*$;const te=requestAnimationFrame(p);return e.dataset.scrollAnimationId=te,te},y=requestAnimationFrame(p);return e.dataset.scrollAnimationId=y,y}static confirmReload(e=game.i18n.localize("CRLNGN_UI.ui.reloadRequiredTitle"),t=game.i18n.localize("CRLNGN_UI.ui.reloadRequiredLabel"),n={}){const a={title:e,content:t,yes:{label:game.i18n.localize("CRLNGN_UI.ui.reloadButton"),callback:()=>(f.log("Reloading page after confirmation"),window.location.reload(),!0)},no:{label:game.i18n.localize("CRLNGN_UI.ui.cancelButton"),callback:()=>!1},defaultYes:!1,rejectClose:!1};return mergeObject(a,n),foundry.applications.api.DialogV2.confirm(a)}static renderTemplate(e,t){return foundry.applications.handlebars.renderTemplate(e,t)}static loadTemplate(e){return foundry.applications.handlebars.loadTemplate(e)}static isValidCSSRule(e){if(!e||typeof e!="string")return!1;try{const t=document.createElement("style");t.type="text/css",t.innerHTML=e,document.head.appendChild(t);const n=!!(t.sheet&&t.sheet.cssRules&&t.sheet.cssRules.length>0);return document.head.removeChild(t),n}catch(t){return f.log("CSS validation error:",[t,e]),!1}}};h(Gt,"processStyleSheets",async()=>{const e=new Set(Object.keys(CONFIG.fontDefinitions));f.log("Foundry built-in fonts:",[Array.from(e)]);const t=game.settings.get("core","fonts")||{},n=Object.entries(t).map(([s])=>s);f.log("Stylesheets:",[document.styleSheets]);const a=new Set;for(const s of document.styleSheets)try{if(s.ownerNode){const r=s.href||"",c=r.includes("css/")||r.includes("styles/"),d=r.includes("modules/crlngn-ui/"),g=r.includes("systems/");if(r&&!c&&!d&&!g){f.log("Skipping stylesheet:",[r]);continue}f.log("Processing stylesheet:",[s,r]),await Gt.processStyleSheetRules(s,a)}}catch(r){f.warn("Error processing stylesheet:",[r])}return f.log("Found fonts:",[{foundry:Array.from(e),custom:n,cssImported:Array.from(a)}]),Array.from(new Set([...e,...n,...a])).filter(s=>!/FontAwesome|Font Awesome|FoundryVTT/.test(s)).map(s=>s.replace(/['"]/g,"").trim()).sort((s,r)=>s.toLowerCase().localeCompare(r.toLowerCase()))}),h(Gt,"wrapFontName",e=>{const t=e.replace(/['"`]/g,"");return t.includes(" ")?`"${t}"`:t});let R=Gt;var Be,qt,Ht;const G=class G{static init(){f.log("LeftControls - init",[]),Hooks.on(A.RENDER_SCENE_CONTROLS,G.initSceneControls),Hooks.on(A.ACTIVATE_SCENE_CONTROLS,G.onActivateSceneControls),window.addEventListener("resize",G.onActivateSceneControls),G.initSceneControls()}static applyFadeOut(e){G.useFadeOut=e,f.log("applyFadeOut",[e]),G.handleFadeOut()}static applyHide(e){G.hidden=e,G.handleHide()}static handleHide(e,t,n){const a=t||document.querySelector("#scene-controls");G.hidden?a==null||a.classList.add("hidden-ui"):a==null||a.classList.remove("hidden-ui"),f.log("handle Hide",[G.hidden])}static handleFadeOut(e,t,n){const a=t||document.querySelector("#scene-controls"),o=document.querySelector("#touch-vtt-controls");G.useFadeOut?(a==null||a.classList.add("faded-ui"),o==null||o.classList.add("faded-ui")):(a==null||a.classList.remove("faded-ui"),o==null||o.classList.remove("faded-ui")),f.log("handle FadeOut",[G.customStylesEnabled,G.useFadeOut])}static applyCustomStyle(e){var t;G.customStylesEnabled=e,f.log("applyCustomStyle",[G.customStylesEnabled,ui.controls]),(t=ui.controls)==null||t.render()}static resetLocalVars(){k(G,Be,document.querySelector("#ui-left #controls")),k(G,qt,document.querySelector("#ui-left"))}static initSceneControls(e,t,n){f.log("initSceneControls",[]),G.resetLocalVars();const a=document.querySelector("#interface");G.customStylesEnabled?a==null||a.classList.add("crlngn-controls"):a==null||a.classList.remove("crlngn-controls"),G.handleFadeOut(e,t,n),G.handleHide(e,t,n)}static observeControlsWidth(){if(f.log("observeControlsWidth",[]),!m(G,Be))return;let e;const t=(n,a)=>{e||(e=setTimeout(()=>{n(),e=null},a))};k(G,Ht,new ResizeObserver(n=>{t(()=>G.updateCSSVars(),250)})),m(G,Ht).observe(m(G,Be),{box:"border-box"}),G.updateCSSVars()}static updateCSSVars(){if(!m(G,Be))return;let e=parseInt(m(G,qt).offsetWidth),t=parseInt(m(G,Be).offsetWidth),n=-e+t;f.log("updateCSSVars",[t,e]),!isNaN(t)&&!isNaN(e)&&R.addCSSVars("--ui-controls-margin-left",n+"px")}static onActivateSceneControls(e,t){const n=document.querySelectorAll("#scene-controls-layers .ui-control"),a=document.querySelectorAll("#scene-controls-tools .ui-control"),o=getComputedStyle(document.querySelector("#ui-left")).getPropertyValue("--control-columns");a.length>=n.length?(document.querySelector("#scene-controls").classList.add("more-tools"),Number(o)>2?document.querySelector("#scene-controls").classList.add("extra-columns"):document.querySelector("#scene-controls").classList.remove("extra-columns")):(document.querySelector("#scene-controls").classList.remove("more-tools"),document.querySelector("#scene-controls").classList.remove("extra-columns")),f.log("onActivateSceneControls",[o,a.length,n.length])}};Be=new WeakMap,qt=new WeakMap,Ht=new WeakMap,T(G,Be),T(G,qt),T(G,Ht),h(G,"useFadeOut",!0),h(G,"hidden",!1),h(G,"customStylesEnabled",!0),h(G,"preloadTemplates",async()=>{try{const e=[`modules/${MODULE_ID}/templates/chat-toggle-button.hbs`];return await loadTemplates(e),!0}catch(e){return f.log("Error loading navigation button templates:",[e]),!1}});let ut=G;foundry.utils;const{ApplicationV2:eo,HandlebarsApplicationMixin:to}=foundry.applications.api;var La,K,pt,na,ie,Ta,wa,Ra,Xn,Jn,Ia;const I=class I extends to(eo){constructor(){super(...arguments);h(this,"_onRender",(t,n)=>{w(),k(I,K,this.element);const a=m(I,K).querySelector('input[type="range"][name="sceneItemWidth"]'),o=m(I,K).querySelector('input[type="number"].range-value-input[name="sceneItemWidth_value"]');a&&o&&I.handleRangeInputs(a,o);const s=m(I,K).querySelector('input[type="range"][name="sideBarWidth"]'),r=m(I,K).querySelector('input[type="number"].range-value-input[name="sideBarWidth_value"]');s&&r&&I.handleRangeInputs(s,r);const c=m(I,K).querySelectorAll(".toggle-hint");f.log("_onRender",[t,n,this.element]),c.forEach(d=>{d.addEventListener("click",()=>{m(I,K).querySelectorAll("p.hint").forEach(g=>g.classList.toggle("shown"))})}),I.handleCustomFontFields(),I.handleThemeAndStyleFields(),f.log("_onRender",[t,n])})}_configureRenderParts(t){const n=super._configureRenderParts(t),a=I.getRestrictedTabs();return game.user.isGM||a.forEach(o=>{delete n[o]}),n}async _prepareContext(t){const n=await super._prepareContext(t);n.activeTab=t.activeTab||Object.keys(n.tabs)[0],n.isGM=game.user.isGM,w(),n.themes=Ke;const a=await R.getAllFonts();return n.fontList=a,n}async _preparePartContext(t,n,a){var r,c,d;const o=await super._preparePartContext(t,n,a);t in n.tabs&&(o.tab=o.tabs[t]),w(),ka();const s=I.getRestrictedTabs();switch(game.user.isGM||s.forEach(g=>{delete o.tabs[g]}),t){case"tabs":break;case"footer":{o.buttons=[{type:"button",icon:"",label:"CRLNGN_UI.settings.moduleSettingsMenu.reset",action:"redefine"},{type:"submit",icon:"",label:"CRLNGN_UI.settings.moduleSettingsMenu.save"}];break}default:{o.tab=o.tabs[t];const g=((r=I.PARTS[t])==null?void 0:r.menuKey)||null;if(g){const p=I.getMenuContext(g);if(p.fields&&(o.fields={...o.fields,...p.fields}),p.fieldDefaults&&(o.fieldDefaults={...o.fieldDefaults,...p.fieldDefaults}),p.fieldValues){if(t==="themes"){const y=Ke.find(C=>C.className===p.fieldValues.colorTheme);p.fieldValues.colorTheme=(y==null?void 0:y.label)||Ke[0].label}Object.assign(o,p.fieldValues)}o.sidebarTabs=Object.values(((d=(c=foundry.applications)==null?void 0:c.sidebar)==null?void 0:d.tabs)||{}).map(y=>({tabName:y.tabName,name:y.name,hideForGM:!1,hideForPlayer:!1,localizedName:`CRLNGN_UI.settings.sidebarTabs.${y.name}`}))}break}}return f.log("_preparePartContext",[o,t]),o}static getMenuContext(t){var c;const n=w(),a=((c=n[t])==null?void 0:c.fields)||null;if(!a)return{};const o={},s={},r={};return a.forEach(d=>{if(n[d]){const g=E.get(n[d].tag);o[d]=n[d],s[d]=g!==void 0?g:n[d].default,r[d]=n[d].default}}),{fields:o,fieldValues:s,fieldDefaults:r}}static getRestrictedTabs(){const t=[];return Object.entries(I.PARTS).forEach((n,a)=>{n[0]!=="tabs"&&n[0]!=="footer"&&n[1].isGMOnly&&t.push(n[0])}),t}static handleRangeInputs(t,n){if(t&&n){const a=parseInt(t.min,10),o=parseInt(t.max,10);t.addEventListener("input",()=>{n.value=t.value}),n.addEventListener("input",()=>{const s=n.value;if(s===""||s==="-")return;const r=parseInt(s,10);!isNaN(r)&&r>=a&&r<=o&&(t.value=r)}),n.addEventListener("change",()=>{let s=parseInt(n.value,10);isNaN(s)||s<a?s=a:s>o&&(s=o),n.value=s,t.value=s}),n.value=t.value}}static updateSettings(t){let n=!1;const a=w(),r=m(I,K).querySelector(".form-content.active").dataset.tab;if(k(I,pt,r),!t)return;let c;t.object&&(c=foundry.utils.expandObject(t.object));const d=Ke.find(g=>g.label===c.colorTheme);return c.colorTheme=d?d.className:Ke[0].className,Object.entries(c).forEach(([g,p])=>{var y;if(!g.endsWith("_value")&&(f.log("updateSettings #1",[a,a[g]]),c[g]!==void 0&&a[g])){const C=E.get(a[g].tag);E.set(a[g].tag,c[g]),(y=a[g])!=null&&y.requiresReload&&C!==c[g]&&(n=!0)}}),ui.notifications.info(game.i18n.localize("CRLNGN_UI.ui.notifications.settingsUpdated")),n}changeTab(t,n,a){super.changeTab(t,n,a),k(I,pt,t)}static handleCustomFontFields(){const t=m(I,K).querySelector(".form-content[data-tab=fonts]");if(!t)return;t.querySelectorAll('input[type="text"]').forEach(o=>{const s=o.closest(".dropdown-wrapper"),r=s==null?void 0:s.querySelector(".dropdown-options");if(!s||!r)return;const c=()=>{var d;ne(d=I,ie,Xn).call(d),r.classList.add("active")};o.addEventListener("focus",c),o.addEventListener("click",c),o.addEventListener("keydown",ne(I,ie,Jn)),document.addEventListener("click",d=>{s.contains(d.target)||r.classList.remove("active")})}),t.querySelectorAll(".dropdown-option").forEach(o=>{o.addEventListener("mouseenter",()=>{o.closest(".dropdown-options").querySelectorAll(".dropdown-option").forEach(r=>r.classList.remove("highlighted")),o.classList.add("highlighted")}),o.addEventListener("click",s=>{const r=o.closest(".dropdown-wrapper").querySelector("input");let c=o.dataset.value;c.includes(" ")&&!c.startsWith('"')?c=`"${c}"`:c.startsWith("&quot;")&&(c=c.replace(/&quot;/g,'"')),r.value=c;const d=o.closest(".dropdown-options");d.classList.remove("active"),f.log("handleCustomFontFields",[c,r,d])})})}static handleThemeAndStyleFields(){const t=m(I,K).querySelector(".form-content[data-tab=themes]");if(!t)return;t.querySelectorAll('input[type="text"]:not([hidden])').forEach(c=>{const d=c.closest(".dropdown-wrapper"),g=d==null?void 0:d.querySelector(".dropdown-options");if(!d||!g)return;const p=()=>{var y;ne(y=I,ie,Xn).call(y),g.classList.add("active")};c.addEventListener("focus",p),c.addEventListener("click",p),c.addEventListener("keydown",ne(I,ie,Jn)),document.addEventListener("click",y=>{d.contains(y.target)||g.classList.remove("active")})}),t.querySelectorAll(".dropdown-option").forEach(c=>{c.addEventListener("mouseenter",()=>{c.closest(".dropdown-options").querySelectorAll(".dropdown-option").forEach(g=>g.classList.remove("highlighted")),c.classList.add("highlighted")}),c.addEventListener("click",function(d){var C,L,O;f.log("theme option",[c,c.querySelector(".theme-name")]);const g=(C=c.closest(".dropdown-wrapper"))==null?void 0:C.querySelector("input");let p=(L=c.querySelector(".theme-name"))==null?void 0:L.innerHTML.toString();if(g.value=p,g.name==="colorTheme"){const $=Ke.find(te=>te.label===p);ne(O=I,ie,Ia).call(O,$)}c.closest(".dropdown-options").classList.remove("active")})});const o=m(I,K).querySelectorAll('.multiple-select.other-modules input[type="checkbox"]'),s=m(I,K).querySelector('input.otherModulesList[type="hidden"]');o.forEach(c=>{c.addEventListener("change",d=>{const g=d.currentTarget;let y=`${s.value}`.split(",")||[],C=y.indexOf(g.value);!d.currentTarget.checked&&C>-1?y.splice(C,1):d.currentTarget.checked&&C===-1&&y.push(g.value),s.value=y.join(","),f.log("checkbox changed",[y,s.value])})});const r=m(I,K).querySelector("input.adjustOtherModules");r==null||r.addEventListener("change",c=>{const d=m(I,K).querySelectorAll('.multiple-select.other-modules input[type="checkbox"]');d.forEach(y=>{y.checked=c.currentTarget.checked;const C=new Event("change",{bubbles:!0});y.dispatchEvent(C)});const g=[],p=m(I,K).querySelector('input.otherModulesList[type="hidden"]');d.forEach(y=>{y.checked&&g.push(y.value)}),p.value=g.join(","),g.length===0&&(r.checked=!1)})}};K=new WeakMap,pt=new WeakMap,na=new WeakMap,ie=new WeakSet,Ta=async function(t,n,a){t.preventDefault(),t.stopPropagation(),I.updateSettings(a)&&R.confirmReload()},wa=async function(t,n){const a=w(),s=m(I,K).querySelector(".form-content.active"),r=s.dataset.tab,c=I.PARTS[r].menuKey,d=a[c].default;s.querySelectorAll("input, select").forEach(p=>{p.value=d[p.name],p.type==="checkbox"&&(p.checked=d[p.name])}),f.log("#onReset",[m(I,pt),r,t,n])},Ra=function(){var a;const t=[],n=I.PARTS;return((a=game.system)==null?void 0:a.id)!=="dnd5e"&&delete n.sheets5e,f.log("#getTabs",[n,I.PARTS]),Object.entries(n).forEach(([o,s])=>{s.menuKey&&t.push({id:o,icon:"",group:"primary-tabs",label:`CRLNGN_UI.settings.moduleSettingsMenu.tabs.${o}`})}),t},Xn=function(){m(I,K).querySelectorAll(".dropdown-options").forEach(t=>{t.classList.remove("active")})},Jn=function(t){const n=t.target.closest(".dropdown-wrapper"),a=n==null?void 0:n.querySelector(".dropdown-options"),o=a.classList.contains("active"),s=Array.from(a.querySelectorAll(".dropdown-option"));let r=s.findIndex(c=>c.classList.contains("highlighted"));t.key==="ArrowDown"||t.key==="ArrowUp"?(t.preventDefault(),o||a.classList.add("active"),s.forEach(c=>c.classList.remove("highlighted")),r===-1?r=t.key==="ArrowDown"?0:s.length-1:r=t.key==="ArrowDown"?(r+1)%s.length:(r-1+s.length)%s.length,s[r]&&(s[r].classList.add("highlighted"),s[r].scrollIntoView({block:"nearest"}))):t.key==="Enter"?(t.preventDefault(),o&&r!==-1&&s[r]&&s[r].click()):t.key==="Escape"&&a.classList.remove("active")},Ia=function(t){if(f.log("Selected theme updated:",[t]),!t)return;m(I,K).querySelectorAll("span.selected-theme").forEach((a,o)=>{a.style.setProperty("background-color",t.colorPreview[o])})},T(I,ie),T(I,K),T(I,pt),T(I,na),h(I,"selectedTheme"),h(I,"DEFAULT_OPTIONS",{id:"crlngn-ui-settings",tag:"form",window:{icon:"fas fa-cog",title:"CRLNGN_UI.settings.moduleSettingsMenu.title",contentClasses:["standard-form","crlngn","tabbed-settings"],resizable:!0},position:{width:700,height:"auto"},actions:{redefine:ne(I,ie,wa)},form:{handler:ne(I,ie,Ta),closeOnSubmit:!0}}),h(I,"PARTS",{tabs:{template:"templates/generic/tab-navigation.hbs",isGMOnly:!1},interface:{menuKey:"interfaceOptionsMenu",template:"modules/crlngn-ui/templates/interface-elements-settings.hbs",isGMOnly:!1},themes:{menuKey:"themeAndStylesMenu",template:"modules/crlngn-ui/templates/theme-and-styles-settings.hbs",isGMOnly:!1},fonts:{menuKey:"customFontsMenu",template:"modules/crlngn-ui/templates/custom-fonts-settings.hbs",isGMOnly:!0},chat:{menuKey:"chatMessagesMenu",template:"modules/crlngn-ui/templates/chat-messages-settings.hbs",isGMOnly:!1},scenes:{menuKey:"sceneNavMenu",template:"modules/crlngn-ui/templates/scene-nav-settings.hbs",isGMOnly:!1},players:{menuKey:"playersListMenu",template:"modules/crlngn-ui/templates/players-list-settings.hbs",isGMOnly:!1},camera:{menuKey:"cameraDockMenu",template:"modules/crlngn-ui/templates/camera-dock-settings.hbs",isGMOnly:!1},footer:{template:"templates/generic/form-footer.hbs",isGMOnly:!1}}),h(I,"TABS",{primary:{initial:"interface",tabs:ne(La=I,ie,Ra).call(La),labelPrefix:""}});let $n=I;function ka(){return{moduleSettingsMenu:{tab:"",tag:game.i18n.localize("CRLNGN_UI.settings.moduleSettingsMenu.label"),name:game.i18n.localize("CRLNGN_UI.settings.moduleSettingsMenu.title"),label:game.i18n.localize("CRLNGN_UI.settings.moduleSettingsMenu.title"),hint:game.i18n.localize("CRLNGN_UI.settings.moduleSettingsMenu.hint"),icon:"fas fa-sliders-h",propType:$n,restricted:!1}}}var et,xe,Bt,xt,Ut,Wt,Vt,jt,Yt,$t,tt,Xt,Jt;const u=class u{static applyFadeOut(e){u.useFadeOut=e,u.cameraContainer&&u.cameraContainer.classList.toggle("faded-ui",e)}static applyHide(e){u.hidden=e,u.cameraContainer&&u.cameraContainer.classList.toggle("hidden",e)}static applyCustomStyle(e){var t;u.enableFloatingDock=e,f.log("applyCustomStyle",["enableFloatingDock",e,u.enableFloatingDock,ui.webrtc]),(t=ui.webrtc)==null||t.render()}static init(){const e=w();u.enableFloatingDock=E.get(e.enableFloatingDock.tag),u.currSettings={enableFloatingDock:u.enableFloatingDock,defaultVideoWidth:E.get(e.defaultVideoWidth.tag),dockHeight:E.get(e.dockHeight.tag),dockWidth:E.get(e.dockWidth.tag),dockPosX:E.get(e.dockPosX.tag),dockPosY:E.get(e.dockPosY.tag),dockResizeOnUserJoin:E.get(e.dockResizeOnUserJoin.tag)},u.enableFloatingDock?(u.positionIntervalId&&(clearInterval(u.positionIntervalId),u.positionIntervalId=null),Hooks.on(A.RENDER_CAMERA_VIEWS,u.onRenderFloating),Hooks.on(A.RENDER_PLAYERS_LIST,u.onRenderPlayersList),Hooks.on(A.CLIENT_SETTING_CHANGED,t=>{f.log("Setting updated",[t]),t.includes("rtcClientSettings")&&u.checkMinimizedState()})):(Hooks.on(A.RENDER_CAMERA_VIEWS,u.onRenderPlain),u.onRenderPlain())}static onRenderPlain(e,t){var n;u.cameraContainer||(u.cameraContainer=document.querySelector("#av-holder")),(n=u.cameraContainer)==null||n.classList.add("visible")}static onRenderFloating(e,t,n){w();const a=u.currSettings,o=document.querySelector("#camera-views");if(u.cameraContainer=document.querySelector("#av-holder"),u.cameraContainer)u.cameraContainer.appendChild(o);else{const d=document.createElement("div");u.cameraContainer=d,d.id="av-holder",d.appendChild(o),document.querySelector("body.crlngn-ui").appendChild(d)}u.cameraContainer.querySelector("button[data-action=toggleDock]").addEventListener("click",()=>{var d;(d=ui.webrtc)==null||d.render()}),((t==null?void 0:t.querySelectorAll(".camera-view"))||[]).forEach(d=>{const g=game.users.get(d.dataset.user),p=(g==null?void 0:g.color)||"";d.style.setProperty("--player-color",p)}),f.log("CameraDockUtil.onRender",[e,t,n,a.dockPosX,a.dockPosY]);const c=game.settings.get("core","rtcClientSettings");(c==null?void 0:c.hideDock)!==!0?(u.checkMinimizedState(),u.applyDockResize(a.dockResizeOnUserJoin),u.makeDraggable(),u.makeResizeable(),u.applyVideoWidth(),u.resetPositionAndSize()):u.checkMinimizedState(),u.applyFadeOut(u.useFadeOut)}static onRenderPlayersList(){f.log("onRenderPlayersList")}static applyPositionWithDelay(){u.positionIntervalId&&(clearInterval(u.positionIntervalId),u.positionIntervalId=null),u.resetPositionAndSize();let e=0;u.positionIntervalId=setInterval(()=>{u.resetPositionAndSize(),e++,e>=u.positionAttempts&&(clearInterval(u.positionIntervalId),u.positionIntervalId=null)},20)}static applyVideoWidth(e){const t=w(),n=E.get(t.defaultVideoWidth.tag);let a=e||n;if(a<Gn)a=Gn,E.set(t.defaultVideoWidth.tag,a);else if(!Number.isNaN(a)){u.currSettings.defaultVideoWidth=a;const o=document.querySelector("#av-holder.minimized #camera-views"),s=document.querySelector("#camera-views");!o&&s&&(s.parentNode.style.setProperty("--av-width",a+"px"),s.style.setProperty("--av-width",a+"px")),u.updateDockSize()}}static resetPositionAndSize({x:e,y:t,w:n,h:a}={x:null,y:null,w:null,h:null}){w();const o=u.currSettings;if(!u.enableFloatingDock||!u.cameraContainer)return;const s=game.settings.get("core","rtcClientSettings");if((s==null?void 0:s.hideDock)===!0){u.checkMinimizedState();return}if(f.log("CameraDock",[o]),!e&&!t&&!n&&!a){const r=o.dockPosX||0,c=o.dockPosY||0;if(u.cameraContainer.style.left=`${r}px`,u.cameraContainer.style.bottom=`${c}px`,u.currSettings.dockResizeOnUserJoin===ke.off.name){const d=o.dockWidth||0,g=o.dockHeight||0;u.cameraContainer.style.width=`${d}px`,u.cameraContainer.style.height=`${g}px`}}else e!==null&&(u.cameraContainer.style.left=`${e}px`),t!==null&&(u.cameraContainer.style.bottom=`${t}px`),u.currSettings.dockResizeOnUserJoin===ke.horizontal.name?n!==null&&(u.cameraContainer.style.width=`${n}px`):u.currSettings.dockResizeOnUserJoin===ke.vertical.name&&a!==null&&(u.cameraContainer.style.height=`${a}px`)}static makeDraggable(){var e,t;(e=u.cameraContainer)==null||e.addEventListener("mousedown",n=>{var c,d;const a=document.querySelector("#av-holder.minimized #camera-views");if(n.button!==0)return;const o=document.querySelector("body.crlngn-ui");if(f.log("mousedown",[n.target.tagName,n.target.parentNode.tagName]),n.target.tagName=="input"||(c=n.target.parentNode)!=null&&c.classList.contains("webrtc-volume-slider")||(o==null||o.addEventListener("mousemove",m(u,jt)),o==null||o.addEventListener("mouseup",m(u,Yt)),a))return;const s=R.getOffsetBottom(u.cameraContainer);let r=((d=u.cameraContainer)==null?void 0:d.offsetLeft)||0;u.isDragging=!0,k(u,et,n.clientX-r),k(u,xe,window.innerHeight-n.clientY-s),n.preventDefault(),n.stopPropagation()}),(t=u.cameraContainer)==null||t.addEventListener("touchstart",n=>{var d,g;const a=document.querySelector("#av-holder.minimized #camera-views");if(!n.touches[0])return;const o=document.querySelector("body.crlngn-ui");if((d=n.target.parentNode)!=null&&d.classList.contains("volume-bar")||(o.addEventListener("touchmove",m(u,$t)),o.addEventListener("touchend",m(u,tt)),o.addEventListener("touchcancel",m(u,tt)),a))return;const s=n.touches[0],r=R.getOffsetBottom(u.cameraContainer);let c=((g=u.cameraContainer)==null?void 0:g.offsetLeft)||0;u.isDragging=!0,k(u,et,s.clientX-c),k(u,xe,window.innerHeight-s.clientY-r),n.preventDefault(),n.stopPropagation()})}static updateDockSize(){var c,d;if(!u.cameraContainer)return;const e=w(),t=u.currSettings.dockResizeOnUserJoin,n=u.currSettings.defaultVideoWidth||Gn,o=(((d=(c=game.webrtc)==null?void 0:c.users)==null?void 0:d.filter(g=>g.active&&g.canBroadcastVideo))||[]).length;if(o===0)return;if(t===ke.horizontal.name){const g=n*o+16;u.cameraContainer.style.width=`${g}px`}else if(t===ke.vertical.name){const g=n*o+16;u.cameraContainer.style.height=`${g}px`}const s=parseInt(u.cameraContainer.style.width||0),r=parseInt(u.cameraContainer.style.height||0);s>0&&E.set(e.dockWidth.tag,s),r>0&&E.set(e.dockHeight.tag,r)}static applyDockResize(e=null){if(!u.cameraContainer)return;e?u.currSettings.dockResizeOnUserJoin=e:e=u.currSettings.dockResizeOnUserJoin,u.cameraContainer.classList.remove("horizontal"),u.cameraContainer.classList.remove("vertical");const t=u.cameraContainer.querySelector("#camera-views");t.classList.remove("horizontal"),t.classList.remove("vertical"),e===ke.horizontal.name?u.cameraContainer.classList.add("horizontal"):e===ke.vertical.name&&u.cameraContainer.classList.add("vertical"),u.updateDockSize()}static makeResizeable(){if(u.cameraContainer){const e=document.querySelector("body.crlngn-ui"),t=document.createElement("div"),n=u.cameraContainer.querySelector(".resize-handle");n&&n.remove(),t.classList.add("resize-handle"),u.cameraContainer.append(t),t.addEventListener("mousedown",a=>{a.preventDefault(),a.stopPropagation(),u.isResizing=!0,k(u,Bt,a.clientX),k(u,xt,a.clientY),k(u,Vt,parseInt(getComputedStyle(u.cameraContainer).bottom)||0),k(u,Ut,u.cameraContainer.offsetWidth),k(u,Wt,u.cameraContainer.offsetHeight),e==null||e.addEventListener("mousemove",m(u,Xt)),e==null||e.addEventListener("mouseup",m(u,Jt))})}}static checkMinimizedState(){if(!u.cameraContainer)return;const e=game.settings.get("core","rtcClientSettings"),t=(e==null?void 0:e.hideDock)===!0;t?document.querySelector("#av-holder").classList.add("minimized"):document.querySelector("#av-holder").classList.remove("minimized"),f.log("Checking minimized state",[e,t]),u.handleMinimizedState(t)}static handleMinimizedState(e){var o;const t=document.querySelector("#interface #players #players-active"),n=u.cameraContainer.querySelector("button[data-action=toggleDock]");if(!t||!n||!u.cameraContainer)return;if(f.log("handleMinimizedState",[e]),e)u.cameraContainer.parentNode!==t&&(u.originalParent=u.cameraContainer.parentNode,t.prepend(u.cameraContainer),n.classList.remove("fa-caret-down"),n.classList.remove("fa-caret-left"),n.classList.remove("fa-caret-right"),n.classList.remove("fa-compress"),n.classList.add("fa-camera"));else{if(!u.originalParent)return;u.originalParent.prepend(u.cameraContainer),u.makeDraggable(),u.makeResizeable(),n.classList.remove("fa-caret-up"),n.classList.remove("fa-caret-left"),n.classList.remove("fa-caret-right"),n.classList.remove("fa-expand"),n.classList.add("fa-caret-down"),f.log("Restored camera position from settings",[u.currSettings])}const a=(o=u.cameraContainer)==null?void 0:o.querySelector("#camera-views");a==null||a.classList.remove("horizontal"),a==null||a.classList.remove("vertical")}};et=new WeakMap,xe=new WeakMap,Bt=new WeakMap,xt=new WeakMap,Ut=new WeakMap,Wt=new WeakMap,Vt=new WeakMap,jt=new WeakMap,Yt=new WeakMap,$t=new WeakMap,tt=new WeakMap,Xt=new WeakMap,Jt=new WeakMap,T(u,et,0),T(u,xe,0),h(u,"isDragging",!1),h(u,"cameraContainer"),h(u,"isResizing",!1),T(u,Bt,0),T(u,xt,0),T(u,Ut,0),T(u,Wt,0),T(u,Vt,0),h(u,"currSettings",{}),h(u,"positionIntervalId",null),h(u,"positionAttempts",5),h(u,"useFadeOut",!0),h(u,"hidden",!1),h(u,"enableFloatingDock",!0),T(u,jt,e=>{const t=document.querySelector("#av-holder.minimized #camera-views");if(!(!u.isDragging||t)){if(f.log("mousemove",[window.innerHeight,e.clientY,m(u,xe)]),u.cameraContainer){let n=e.clientX-m(u,et),a=window.innerHeight-e.clientY-m(u,xe);n+u.cameraContainer.offsetWidth>window.innerWidth&&(n=window.innerWidth-u.cameraContainer.offsetWidth),n<0&&(n=0),u.cameraContainer.style.left=`${n}px`,a+u.cameraContainer.offsetHeight>window.innerHeight&&(a=window.innerHeight-u.cameraContainer.offsetHeight),u.cameraContainer.style.bottom=`${a}px`}e.preventDefault(),e.stopPropagation()}}),T(u,Yt,e=>{var o,s;const t=w(),n={...u.currSettings},a=document.querySelector("#av-holder.minimized #camera-views");if(u.isDragging&&!a){const r=document.querySelector("body.crlngn-ui");n.dockPosX=parseInt((o=u.cameraContainer)==null?void 0:o.style.left)||0,n.dockPosY=parseInt((s=u.cameraContainer)==null?void 0:s.style.bottom)||0,n.dockPosY<=0&&(n.dockPosY=0),E.set(t.dockPosX.tag,n.dockPosX),E.set(t.dockPosY.tag,n.dockPosY),r==null||r.removeEventListener("mousemove",m(u,jt)),r==null||r.removeEventListener("mouseup",m(u,Yt)),u.isDragging=!1,e.stopPropagation()}}),T(u,$t,e=>{if(!(!u.isDragging||!e.touches[0])){if(u.cameraContainer){const t=e.touches[0];let n=t.clientX-m(u,et),a=window.innerHeight-t.clientY-m(u,xe);n+u.cameraContainer.offsetWidth>window.innerWidth&&(n=window.innerWidth-u.cameraContainer.offsetWidth),n<0&&(n=0),u.cameraContainer.style.left=`${n}px`,a+u.cameraContainer.offsetHeight>window.innerHeight&&(a=window.innerHeight-u.cameraContainer.offsetHeight),u.cameraContainer.style.bottom=`${a}px`}e.preventDefault(),e.stopPropagation()}}),T(u,tt,e=>{var a,o;const t=w(),n={...u.currSettings};if(u.isDragging){const s=document.querySelector("body.crlngn-ui");n.dockPosX=parseInt((a=u.cameraContainer)==null?void 0:a.style.left)||0,n.dockPosY=parseInt((o=u.cameraContainer)==null?void 0:o.style.bottom)||0,n.dockPosY<=0&&(n.dockPosY=0),E.set(t.dockPosX.tag,n.dockPosX),E.set(t.dockPosY.tag,n.dockPosY),s==null||s.removeEventListener("touchmove",m(u,$t)),s==null||s.removeEventListener("touchend",m(u,tt)),s==null||s.removeEventListener("touchcancel",m(u,tt)),u.isDragging=!1,e.preventDefault(),e.stopPropagation()}}),T(u,Xt,e=>{if(!u.isResizing)return;const t=m(u,Ut)+(e.clientX-m(u,Bt)),n=e.clientY-m(u,xt),a=m(u,Wt)+n,o=m(u,Vt)-n;u.cameraContainer.style.width=`${t}px`,u.cameraContainer.style.height=`${a}px`,u.cameraContainer.style.bottom=`${o}px`}),T(u,Jt,()=>{var a,o,s,r,c,d,g;const e=w(),t={...u.currSettings},n=document.querySelector("body.crlngn-ui");u.isResizing=!1,n==null||n.removeEventListener("mousemove",m(u,Xt)),n==null||n.removeEventListener("mouseup",m(u,Jt)),f.log("onStopResize",[(a=u.cameraContainer)==null?void 0:a.style.width,(o=u.cameraContainer)==null?void 0:o.style.height,(s=u.cameraContainer)==null?void 0:s.style.bottom]),t.dockWidth=parseInt(((r=u.cameraContainer)==null?void 0:r.style.width)||0),t.dockHeight=parseInt(((c=u.cameraContainer)==null?void 0:c.style.height)||0),t.dockPosY=parseInt(((d=u.cameraContainer)==null?void 0:d.style.bottom)||0),t.dockPosX=parseInt(((g=u.cameraContainer)==null?void 0:g.style.left)||0),E.set(e.dockWidth.tag,t.dockWidth),E.set(e.dockHeight.tag,t.dockHeight),E.set(e.dockPosY.tag,t.dockPosY),E.set(e.dockPosX.tag,t.dockPosX)});let ee=u;const U=class U{static init(){Hooks.on(A.RENDER_SIDE_BAR,U.onRender),Hooks.on(A.COLLAPSE_SIDE_BAR,U.onRender),Hooks.on(A.READY,U.onRender)}static applyFadeOut(e){U.useFadeOut=e,U.handleFadeOut()}static applyHide(e){U.hidden=e,U.handleHide()}static applyCustomStyle(e){var t;U.customStylesEnabled=e,f.log("applyCustomStyle",[U.customStylesEnabled]),(t=ui.sidebar)==null||t.render()}static onRender(e,t,n){const a=t&&typeof t===HTMLElement?t:document;a.querySelector("#roll-privacy button[data-action='toggleChat']")||U.addChatToggle(a),U.handleFadeOut(e,a,n),U.handleHide(e,a,n)}static handleFadeOut(e,t,n){f.log("handle FadeOut, ChatLogControls",[U.useFadeOut]);const a=t?t.querySelector("#chat-notifications"):document.querySelector("#ui-right #chat-notifications");U.useFadeOut?a==null||a.classList.add("faded-ui"):a==null||a.classList.remove("faded-ui")}static handleHide(e,t,n){f.log("handle Hide, ChatLogControls",[U.hidden]);const a=t?t.querySelector("#chat-notifications"):document.querySelector("#ui-right #chat-notifications");U.hidden?a==null||a.classList.add("hidden-ui"):a==null||a.classList.remove("hidden-ui")}};h(U,"useFadeOut",!0),h(U,"hidden",!1),h(U,"customStylesEnabled",!0),h(U,"addChatToggle",async e=>{if(!U.customStylesEnabled)return;const t=await R.renderTemplate(`modules/${z}/templates/chat-toggle-button.hbs`,{}),n=document.querySelector("#ui-right #roll-privacy");n.insertAdjacentHTML("afterbegin",t);const a=n.querySelector("button[data-action=toggleChat]");a.addEventListener("click",U.onToggleChatBox);const o=game.user.getFlag(z,"chatBoxHidden");if(o!==void 0){f.log("Applying saved chat box state",[o]);const s=document.querySelector("#chat-notifications");o?(a.classList.remove("fa-comment-slash"),a.classList.add("fa-comment"),s.classList.add("input-hidden"),R.addCSSVars("--chat-input-height","0px")):(a.classList.add("fa-comment-slash"),a.classList.remove("fa-comment"),s.classList.remove("input-hidden"),R.addCSSVars("--chat-input-height","100px"))}}),h(U,"onToggleChatBox",e=>{const t=document.querySelector("#ui-right button[data-action=toggleChat]"),n=document.querySelector("#chat-notifications");let a=!1;t.classList.contains("fa-comment-slash")?(t.classList.remove("fa-comment-slash"),t.classList.add("fa-comment"),n.classList.add("input-hidden"),R.addCSSVars("--chat-input-height","0px"),a=!0):(t.classList.add("fa-comment-slash"),t.classList.remove("fa-comment"),n.classList.remove("input-hidden"),R.addCSSVars("--chat-input-height","100px"),a=!1),game.user.setFlag(z,"chatBoxHidden",a),f.log("Chat box state saved to flag",[a])});let gt=U;const he=class he{static init(){const e=w();he.enableChatStyles=E.get(e.enableChatStyles.tag),he.chatBorderColor=E.get(e.chatBorderColor.tag),he.useLeftChatBorder=E.get(e.useLeftChatBorder.tag)}};h(he,"chatBorderColor"),h(he,"enableChatStyles"),h(he,"useLeftChatBorder"),h(he,"enrichCard",async(e,t)=>{var s,r,c,d,g,p,y,C;f.log("renderChatMessage",[he.chatBorderColor,he.enableChatStyles,St.playerColor.name,(s=e.author)==null?void 0:s.id]);const n=((d=(c=(r=e.flags)==null?void 0:r.dnd5e)==null?void 0:c.activity)==null?void 0:d.type)||((y=(p=(g=e.flags)==null?void 0:g.dnd5e)==null?void 0:p.roll)==null?void 0:y.type)||"custom";let a=t.get?t.get(0):t;if(!a)return;a.classList.add(n),a.classList.add("crlngn"),he.useLeftChatBorder&&a.classList.add("left-border");const o=a.querySelectorAll(".card-buttons button[data-action=rollSave]");o.length>0&&o.forEach(L=>{const O=L.querySelector(".visible-dc"),$=L.querySelector(".hidden-dc");f.log("enrichCard",[O,$]),O.setAttribute("data-ability",L.getAttribute("data-ability")||""),O.setAttribute("data-dc",L.getAttribute("data-dc")||""),$.setAttribute("data-ability",L.getAttribute("data-ability")||"")}),he.chatBorderColor===St.playerColor.name&&((C=e.author)!=null&&C.id)&&a.style.setProperty("border-color",`var(--user-color-${e.author.id})`)});let it=he;const B=class B{static init(){this.preloadTemplates(),Hooks.on(A.RENDER_HOTBAR,B.onRender)}static applyFadeOut(e){B.useFadeOut=e,B.handleFadeOut()}static applyHide(e){B.hidden=e,B.handleHide()}static handleHide(e,t,n){const a=t||document.querySelector("#hotbar");B.hidden?a==null||a.classList.add("hidden-ui"):a==null||a.classList.remove("hidden-ui"),f.log("handle Hide",[B.hidden])}static onRender(e,t,n){f.log("MacroHotbar onRender",[B.customStylesEnabled]),B.applyCustomStyle(B.customStylesEnabled),B.handleFadeOut(e,t,n),B.handleHide(e,t,n),B.addCollapseButton(),B.applyHotBarCollapse()}static handleCollapse(e){const t=game.user.getFlag(z,"hotbarCollapsed");B.applyHotBarCollapse(!t)}static handleOpenDirectory(e){f.log("open directory")}static handleFadeOut(e,t,n){const a=t||document.querySelector("#hotbar");B.useFadeOut?a==null||a.classList.add("faded-ui"):a==null||a.classList.remove("faded-ui")}static applyCustomStyle(e){const t=w();B.customStylesEnabled=e!==void 0?e:E.get(t.enableMacroLayout.tag),f.log("applyCustomStyle",[B.customStylesEnabled]),B.applyHotBarLayout()}static applyHotBarLayout(){const e=document.querySelector("#hotbar");e&&(B.customStylesEnabled?e.classList.add("crlngn-macro"):e.classList.remove("crlngn-macro"))}};h(B,"useFadeOut",!0),h(B,"customStylesEnabled",!0),h(B,"macroStartCollapsed",!1),h(B,"hidden",!1),h(B,"preloadTemplates",async()=>{try{const e=[`modules/${z}/templates/macro-buttons.hbs`];return await loadTemplates(e),!0}catch(e){return console.error("Error loading navigation button templates:",e),!1}}),h(B,"addCollapseButton",async()=>{const e=document.querySelector("#hotbar #hotbar-controls-right");if(!e)return;game.user.getFlag(z,"hotbarCollapsed");const t=await R.renderTemplate(`modules/${z}/templates/macro-buttons.hbs`,{});e.insertAdjacentHTML("beforeend",t);const n=e.querySelector("button[data-action=collapse]"),a=e.querySelector("button[data-action=openDirectory]");n==null||n.addEventListener("click",B.handleCollapse),a==null||a.addEventListener("click",B.handleOpenDirectory)}),h(B,"applyHotBarCollapse",async e=>{const t=w();B.macroStartCollapsed=e!==void 0?e:E.get(t.collapseMacroBar.tag),game.user&&await game.user.setFlag(z,"hotbarCollapsed",B.macroStartCollapsed);const n=document.querySelector("#hotbar #hotbar-controls-right"),a=n==null?void 0:n.querySelector("button[data-action=collapse]"),o=document.querySelector("#hotbar");B.macroStartCollapsed&&o?(o.classList.add("collapsed"),a&&(a.classList.remove("fa-angle-down"),a.classList.add("fa-angle-up"),a.dataset.tooltip=game.i18n.localize("CRLNGN_UI.ui.macroBarTooltipKeepOpen"))):(o==null||o.classList.remove("collapsed"),a&&(a.classList.add("fa-angle-down"),a.classList.remove("fa-angle-up"),a.dataset.tooltip=game.i18n.localize("CRLNGN_UI.ui.macroBarTooltipAutoHide")))});let Te=B;var En;const j=class j{static init(){f.log("PlayersList init",[]),Hooks.on(A.RENDER_PLAYERS_LIST,j.onRender)}static applyFadeOut(e){j.useFadeOut=e,j.handleFadeOut()}static applyHide(e){j.hidden=e,j.handleHide()}static handleHide(e,t,n){const a=t||document.querySelector("#players");j.hidden?a==null||a.classList.add("hidden-ui"):a==null||a.classList.remove("hidden-ui"),f.log("handle Hide",[j.hidden])}static handleFadeOut(e,t,n){const a=t||document.querySelector("#players");k(j,En,setTimeout(()=>{f.log("handleFadeOut - PlayersList",[a,j.useFadeOut]),j.useFadeOut?a==null||a.classList.add("faded-ui"):a==null||a.classList.remove("faded-ui"),vt.handleYTPlayerFadeOut()},500))}static applyCustomStyle(e){j.customStylesEnabled=e,ui.players&&ui.players.render()}static onRender(e,t,n){f.log("PlayersList onRender",[e,t,n]),w();const a=t||document.querySelector("#players");j.customStylesEnabled?a==null||a.classList.add("crlngn-ui"):a==null||a.classList.remove("crlngn-ui"),j.applyPlayersListSettings(),j.applyAvatars(),j.handleFadeOut(e,a,n),j.handleHide(e,a,n)}static applyPlayersListSettings(){var t,n,a,o;const e=w();f.log("applyPlayersListSettings",[E.get(e.autoHidePlayerList.tag)]),E.get(e.autoHidePlayerList.tag)?((t=document.querySelector("#players.crlngn-ui"))==null||t.classList.add("minimized"),(n=document.querySelector("body"))==null||n.classList.add("crlngn-players-minimized")):((a=document.querySelector("#players"))==null||a.classList.remove("minimized"),(o=document.querySelector("body"))==null||o.classList.remove("crlngn-players-minimized"))}static applyAvatars(){const e=w();f.log("applyAvatars",[game.users]);const t=document.querySelector("#players"),n=game.users.filter(s=>s.active===!0),a=game.users.filter(s=>s.active===!1),o=[...n,...a];E.get(e.playerListAvatars.tag)&&j.customStylesEnabled?(t==null||t.classList.add("crlngn-avatars"),o.forEach(s=>{var p;const r=t==null?void 0:t.querySelector(`li[data-user-id='${s.id}']`),c=game.users.get(s.id),d=((p=c.character)==null?void 0:p.img)||"";f.log("player",[c]);const g=document.createElement("img");g.src=d||c.avatar||"",g.alt="*",g.classList.add("crlngn-avatar"),r&&r.prepend(g)})):((t==null?void 0:t.querySelectorAll("li.player")).forEach(r=>{const c=r.querySelector("img.crlngn-avatar");c==null||c.remove()}),t==null||t.classList.remove("crlngn-avatars"))}};En=new WeakMap,T(j,En),h(j,"useFadeOut",!0),h(j,"customStylesEnabled",!0),h(j,"playerListAvatars",!0),h(j,"hidden",!1);let Se=j;var aa,Kt,mt;const oe=class oe{static init(){var a;if(R.isModuleOn("foundry-taskbar")&&Hooks.on(A.UPDATE_USER,oe.checkTaskbarLock),oe.checkTaskbarLock(),oe.addModuleClasses(),R.isModuleOn("minimal-ui")&&ui.notifications.warn(game.i18n.localize("CRLNGN_UI.ui.notifications.minimalUiNotSupported"),{permanent:!0}),Hooks.on(A.CLIENT_SETTING_CHANGED,o=>{o.includes("fvtt-youtube-player.windowPosition")&&oe.handleYTPlayerFadeOut()}),k(oe,mt,0),k(oe,Kt,setInterval(()=>{(document.querySelector("#sidebar-video-player")||m(oe,mt)>=10)&&(clearInterval(m(oe,Kt)),oe.handleYTPlayerFadeOut()),fa(oe,mt)._++},200)),R.isModuleOn("dfreds-chat-pins")){const o=document.querySelector("#chat-pins"),s=game.settings.get("core","uiConfig"),r=(a=s==null?void 0:s.colorScheme)==null?void 0:a.interface;f.log("currentTheme",[r,o]),o==null||o.classList.add(`theme-${r}`)}}static handleYTPlayerFadeOut(){var n,a;const e=R.isModuleOn("fvtt-youtube-player"),t=document.querySelector("#sidebar-video-player.tyw-docked");f.log("handleYTPlayerFadeOut",[e,Se.useFadeOut,t]),e&&t&&Se.useFadeOut?(n=document.querySelector("#sidebar-video-player.tyw-docked"))==null||n.classList.add("faded-ui"):e&&((a=document.querySelector("#sidebar-video-player"))==null||a.classList.remove("faded-ui"))}};aa=new WeakMap,Kt=new WeakMap,mt=new WeakMap,T(oe,aa),T(oe,Kt),T(oe,mt,0),h(oe,"addModuleClasses",()=>{const e=w(),t=E.get(e.otherModulesList.tag)||"",n=t.split(",");f.log("addModuleClasses",[n,t]),Object.entries(e.otherModulesList.options).forEach(a=>{const o=a[1].replace(/'/g,"");document.querySelector("body").classList.remove("crlngn-"+o)}),n.forEach(a=>{const o=a.replace(/'/g,"");document.querySelector("body").classList.add("crlngn-"+o)})}),h(oe,"checkTaskbarLock",()=>{var o,s,r;const e=R.isModuleOn("foundry-taskbar");f.log("checkTaskbarLock #1",[e]);const t=(o=game.user.flags)==null?void 0:o["foundry-taskbar"];if(!e||!(t!=null&&t.taskbarSettings))return;const n=game.settings.get("foundry-taskbar","reduceSidebar");f.log("checkTaskbarLock #2",[t,n]),(s=t.taskbarSettings)!=null&&s.locked?R.addCSSVars("--crlngn-margin-bottom",n?"50px":"0px"):R.addCSSVars("--crlngn-margin-bottom",n?"10px":"0px"),(r=t.taskbarSettings)!=null&&r.locked?R.addCSSVars("--crlngn-taskbar-height","50px"):R.addCSSVars("--crlngn-taskbar-height","10px"),R.addCustomCSS("body.crlngn-ui #ui-right {height: calc((100% - var(--crlngn-margin-bottom)) / var(--ui-scale));}");const a=document.querySelector("#ft-move-players-macro");a&&(a.innerHTML="")});let vt=oe;var W,Zt,nt,oa,ht,at,ot,sa,ia,Qt,be,yt,st,Ee,Ue,Oe,Nn,_t,en,Ln,Tn,wn,Rn,In,kn,On;const l=class l{static applyFadeOut(e){l.useFadeOut=e,f.log("applyFadeOut",[e]),l.handleSceneFadeOut()}static applyHide(e){l.hidden=e,l.handleHide()}static handleHide(){const e=document.querySelector("#scene-navigation"),t=document.querySelector("#crlngn-scene-navigation-expand"),n=document.querySelectorAll("#ui-left-column-2 .crlngn-btn");l.hidden?(e==null||e.classList.add("hidden-ui"),t==null||t.classList.add("hidden-ui"),n.forEach(a=>{a.classList.add("hidden-ui")})):(e==null||e.classList.remove("hidden-ui"),t==null||t.classList.remove("hidden-ui"),n.forEach(a=>{a.classList.remove("hidden-ui")})),f.log("handle Hide",[l.hidden])}static applyCustomStyle(e){l.sceneNavEnabled=e,f.log("applyCustomStyle - TopNavigation",[l.sceneNavEnabled,ui.nav])}static resetLocalVars(){k(l,W,document.querySelector("#scene-navigation")),k(l,ht,document.querySelector("#crlngn-scene-navigation-expand")),k(l,at,document.querySelector("#ui-left")),k(l,Zt,document.querySelector("#scene-navigation-inactive"))}static handleSceneFadeOut(e,t,n){const a=document.querySelector("#ui-left-column-2"),o=t||document.querySelector("#ui-left-column-2 #scene-navigation")||null;f.log("handleSceneFadeOut",[t,o,document.querySelector("#ui-left-column-2 #scene-navigation")]),l.sceneNavEnabled?(o==null||o.classList.remove("faded-ui"),l.useFadeOut?a==null||a.classList.add("faded-ui"):a==null||a.classList.remove("faded-ui")):l.useFadeOut?o==null||o.classList.add("faded-ui"):o==null||o.classList.remove("faded-ui")}static handleFolderList(e,t,n){var a;!l.useSceneFolders||!((a=game.user)!=null&&a.isGM)||Qe.addFolderButtons(e,t,n)}static handleNavState(){w(),m(l,Qt)&&(k(l,Qt,!1),l.toggleNav(l.navStartCollapsed))}static updateToggleButton(e){const t=document.querySelector("#crlngn-scene-navigation-expand");if(!t)return;const n=t.querySelector("i"),a=document.querySelector("#scene-navigation");a==null||a.classList.toggle("expanded",e),n&&(n.classList.toggle("fa-caret-down",!e),n.classList.toggle("fa-caret-up",e));const o=e?"SCENE_NAVIGATION.COLLAPSE":"SCENE_NAVIGATION.EXPAND",s=game.i18n.localize(o);t.setAttribute("data-tooltip",o),t.setAttribute("aria-label",s)}static toggleNav(e){l.resetLocalVars(),e===!0?(ui.nav.collapse(),l.isCollapsed=!0,f.log("toggleNav collapse",[ui.nav.collapse,e,l.navStartCollapsed]),document.querySelectorAll("#ui-left .crlngn-btn").forEach(n=>n.remove()),l.updateToggleButton(!1)):e===!1&&(l.isCollapsed=!1,ui.nav.expand(),f.log("toggleNav expand",[e,l.navStartCollapsed]),l.updateToggleButton(!0))}static checkSceneNavCompat(){w(),document.querySelector("#ui-left")}static addListeners(){var e,t,n,a;(e=m(l,W))==null||e.removeEventListener("mouseenter",m(l,_t)),(t=m(l,W))==null||t.removeEventListener("mouseleave",m(l,en)),(n=m(l,W))==null||n.addEventListener("mouseenter",m(l,_t)),(a=m(l,W))==null||a.addEventListener("mouseleave",m(l,en))}static setNavPosition(e=null,t=!0,n=400){var a,o;try{const s=w();if(!m(l,W))return;const r=((a=m(l,W))==null?void 0:a.querySelectorAll("li.nav-item"))||[],c=0,d=e!==null?e:l.navPos||0,g=(o=m(l,W))==null?void 0:o.querySelector("li.nav-item:first-of-type");if(!g)return;const p=r[d],y=g.offsetWidth||0,C=parseInt(y)*d;f.log("setNavPosition",["position",d,C,m(l,W).scrollWidth]);const L=C-c;if(L>m(l,W).scrollWidth)return;l.navPos=d,E.set(s.sceneNavPos.tag,d),t?R.smoothScrollTo(m(l,W),L,"horizontal",n):m(l,W).scrollTo({left:L,behavior:"instant"})}catch(s){f.log("setNavPosition",["Error:",s]),console.error("Error in setNavPosition:",s)}}static loadSettings(){const e=w();l.navStartCollapsed=E.get(e.navStartCollapsed.tag),l.showNavOnHover=E.get(e.showNavOnHover.tag),l.sceneNavEnabled=E.get(e.sceneNavEnabled.tag),l.useScenePreview=E.get(e.useScenePreview.tag),l.useSceneFolders=E.get(e.useSceneFolders.tag),l.navFoldersForPlayers=E.get(e.navFoldersForPlayers.tag),l.navShowRootFolders=E.get(e.navShowRootFolders.tag),l.useSceneIcons=E.get(e.useSceneIcons.tag),l.useSceneBackButton=E.get(e.useSceneBackButton.tag),l.useSceneLookup=E.get(e.useSceneLookup.tag),l.sceneClickToView=E.get(e.sceneClickToView.tag),l.isCollapsed=l.navStartCollapsed}static refreshSettings(){l.loadSettings();const e=document.querySelector("body");l.sceneNavEnabled?e.classList.add("crlngn-scene-nav"):e.classList.remove("crlngn-scene-nav"),ui.nav&&ui.nav.render()}};W=new WeakMap,Zt=new WeakMap,nt=new WeakMap,oa=new WeakMap,ht=new WeakMap,at=new WeakMap,ot=new WeakMap,sa=new WeakMap,ia=new WeakMap,Qt=new WeakMap,be=new WeakMap,yt=new WeakMap,st=new WeakMap,Ee=new WeakMap,Ue=new WeakMap,Oe=new WeakMap,Nn=new WeakMap,_t=new WeakMap,en=new WeakMap,Ln=new WeakMap,Tn=new WeakMap,wn=new WeakMap,Rn=new WeakMap,In=new WeakMap,kn=new WeakMap,On=new WeakMap,T(l,W),T(l,Zt),T(l,nt),T(l,oa),T(l,ht),T(l,at),h(l,"sceneFoldersTemplate"),h(l,"navButtonsTemplate"),T(l,ot),T(l,sa),T(l,ia),T(l,Qt,!0),T(l,be,null),T(l,yt,null),T(l,st,""),T(l,Ee,[]),T(l,Ue,!1),T(l,Oe),h(l,"useFadeOut",!0),h(l,"hidden",!1),h(l,"sceneNavEnabled"),h(l,"useSceneFolders"),h(l,"navFoldersForPlayers"),h(l,"navShowRootFolders"),h(l,"hideInactiveOnFolderToggle"),h(l,"navStartCollapsed"),h(l,"showNavOnHover"),h(l,"useSceneIcons"),h(l,"useScenePreview"),h(l,"useSceneBackButton"),h(l,"useSceneLookup"),h(l,"sceneClickToView"),h(l,"isCollapsed"),h(l,"navPos"),h(l,"init",()=>{w(),Hooks.on(A.RENDER_SCENE_NAV,l.onRender),l.loadSettings(),f.log("SCENE NAV INIT",[l.sceneNavEnabled]);const e=document.querySelector("body");l.sceneNavEnabled?e.classList.add("crlngn-scene-nav"):e.classList.remove("crlngn-scene-nav"),l.sceneNavEnabled&&(l.checkSceneNavCompat(),l.preloadTemplates(),Qe.init(),Hooks.on(A.READY,()=>{l.handleSceneFadeOut(),R.isModuleOn("forien-quest-log")&&Hooks.on("questTrackerBoundaries",t=>t.top=42)}),Hooks.on(A.COLLAPSE_SIDE_BAR,t=>{f.log(A.COLLAPSE_SIDE_BAR,[t]),l.checkSideBar(t.expanded||!1),l.placeNavButtons()}),Hooks.on(A.COLLAPSE_SCENE_NAV,(t,n)=>{clearTimeout(m(l,ot)),l.isCollapsed=n,n&&document.querySelectorAll("#ui-left .crlngn-btn").forEach(o=>o.remove()),k(l,ot,setTimeout(()=>{l.setCollapsedClass(n),l.updateToggleButton(!n)},250))}),l.placeNavButtons()),Hooks.on(A.CREATE_SCENE,()=>{var t;(t=ui.nav)==null||t.render()}),Hooks.on(A.UPDATE_SCENE,()=>{if(m(l,Ue)){k(l,Ue,!1);return}f.log(A.UPDATE_SCENE,[m(l,Ue)])}),Hooks.on(A.DELETE_SCENE,()=>{var t;(t=ui.nav)==null||t.render()}),Hooks.on(A.CANVAS_INIT,()=>{var n,a;const t=(a=(n=game.scenes)==null?void 0:n.viewed)==null?void 0:a.id;t!==m(l,Ee)[m(l,Ee).length-1]&&m(l,Ee).push(t),l.handleSceneFadeOut()}),Hooks.on(A.RENDER_SCENE_DIRECTORY,t=>{f.log(A.RENDER_SCENE_DIRECTORY,[t]),document.querySelector("#scenes .directory-list").querySelectorAll(".directory-item.scene").forEach(o=>{var r,c;const s=game.scenes.get(o.dataset.entryId);if(l.sceneClickToView&&(o.addEventListener("dblclick",l.onActivateScene),o.addEventListener("click",l.onSelectScene)),l.useSceneIcons&&s&&((r=game.user)!=null&&r.isGM)){let d=document.createElement("i");d.classList.add("fas"),d.classList.add("icon"),s.ownership.default!==0?(s.active&&(d.classList.add("fa-bullseye"),o.prepend(d)),((c=game.scenes.current)==null?void 0:c.id)===s.id&&(d.classList.add("fa-star"),o.prepend(d))):(d.classList.add("fa-eye-slash"),o.prepend(d))}})})}),h(l,"onRender",(e,t,n)=>{const a=w(),o=E.get(a.sceneNavPos.tag);if(l.preventNavRender)return;f.log("onRender - "+A.RENDER_SCENE_NAV,[t]),l.resetLocalVars(),l.sceneNavEnabled&&(l.handleExtraButtons(e,t,n),l.handleSceneList(e,t,n),l.handleFolderList(e,t,n),l.setNavPosition(o,!1),l.handleNavState(),l.addSceneListeners(t)),l.addListeners(),l.resetLocalVars(),l.sceneNavEnabled&&l.navShowRootFolders&&game.user.isGM&&(Qe.init(),Qe.renderFolderList()),l.sceneNavEnabled&&(clearTimeout(m(l,ot)),k(l,ot,setTimeout(()=>{f.log("NAV no transition remove"),l.placeNavButtons()},500)));const s=E.get(a.navShowRootFolders.tag),r=E.get(a.hideInactiveOnFolderToggle.tag),c=t.querySelectorAll("#scene-navigation-inactive .scene");f.log("hideInactiveOnToggle",[s,r,c]),r&&s?c.forEach(d=>d.classList.add("hidden")):r&&c.forEach(d=>d.classList.remove("hidden")),l.handleSceneFadeOut(e,t,n)}),h(l,"setCollapsedClass",e=>{const t=document.querySelector("body");e?(m(l,at).classList.add("navigation-collapsed"),t.classList.add("navigation-collapsed"),R.isModuleOn("forien-quest-log")&&Hooks.on("questTrackerBoundaries",n=>n.top=10)):(m(l,at).classList.remove("navigation-collapsed"),t.classList.remove("navigation-collapsed"),l.placeNavButtons(),R.isModuleOn("forien-quest-log")&&Hooks.on("questTrackerBoundaries",n=>n.top=42))}),h(l,"checkSideBar",(e=!1)=>{l.placeNavButtons();const t=document.querySelector("body");f.log("TopNavigation.checkSideBar",[ui.sidebar,e],!0),e?t.classList.add("crlngn-sidebar-expanded"):t.classList.remove("crlngn-sidebar-expanded")}),h(l,"handleSceneList",async(e,t,n)=>{var o,s,r,c;f.log("handleSceneList",[e,t,n,l.useScenePreview,(o=game.user)==null?void 0:o.isGM]);const a=t.querySelectorAll(".scene-navigation-menu li.scene");for(const d of a){const g=d.dataset.sceneId;if(l.useScenePreview&&((s=game.user)!=null&&s.isGM)){const p=game.scenes.find(C=>C.id===g);p.isGM=(r=game.user)==null?void 0:r.isGM;const y=await R.renderTemplate(`modules/${z}/templates/scene-nav-preview.hbs`,p);if(d.classList.add("nav-item"),d.insertAdjacentHTML("beforeend",y),p.isGM&&m(l,st)===g){const C=new MouseEvent("mouseenter");d.dispatchEvent(C)}l.addPreviewIconListeners(d,p)}l.useSceneIcons&&d.classList.add("crlngn")}if(l.sceneNavEnabled){const d=document.querySelector("#ui-left-column-2"),g=document.querySelector("#crlngn-scene-navigation-expand");if(!d)return;g&&g.remove();const p=await R.renderTemplate(`modules/${z}/templates/scene-nav-toggle.hbs`,{isExpanded:((c=ui.nav)==null?void 0:c.expanded)||!1});d.insertAdjacentHTML("afterbegin",p);const y=document.querySelector("#crlngn-scene-navigation-expand");y&&y.addEventListener("click",C=>{C.preventDefault(),C.stopPropagation(),ui.nav&&(f.log("Toggle nav clicked",["expanded:",ui.nav.expanded]),l.toggleNav(ui.nav.expanded))}),l.handleHide()}}),h(l,"handleExtraButtons",async(e,t,n)=>{var s,r,c,d,g;w(),f.log("handleExtraButtons",[e,t,n]);const a=await R.renderTemplate(`modules/${z}/templates/scene-nav-extra-buttons.hbs`,{useSceneBackButton:l.useSceneBackButton,useSceneFolders:(s=game.user)!=null&&s.isGM?l.useSceneFolders:!1,useSceneLookup:(r=game.user)!=null&&r.isGM?l.useSceneLookup:!1,backButtonTooltip:game.i18n.localize("CRLNGN_UI.ui.sceneNav.backButtonTooltip"),sceneLookupTooltip:game.i18n.localize("CRLNGN_UI.ui.sceneNav.sceneLookupTooltip"),isGM:(c=game.user)==null?void 0:c.isGM});(d=t.querySelector("#scene-navigation-active"))==null||d.insertAdjacentHTML("afterbegin",a);const o=t.querySelector("#crlngn-back-button");o&&o.addEventListener("click",m(l,Nn)),l.sceneNavEnabled&&l.useSceneLookup&&((g=game.user)!=null&&g.isGM)&&Qe.handleFolderLookup(e,t,n)}),T(l,Nn,e=>{var o;e.stopPropagation(),e.preventDefault();const t=m(l,Ee).length,n=m(l,Ee)[t-2];let a;f.log("#onBackButton before",[t,n,m(l,Ee)]),n&&n!==((o=game.scenes.current)==null?void 0:o.id)&&(a=game.scenes.get(n),a&&a.view(),m(l,Ee).pop()),f.log("#onBackButton after",[m(l,Ee)])}),T(l,_t,e=>{if(f.log("TopNavigation mouseenter",[]),!l.isCollapsed||!l.showNavOnHover)return;e.stopPropagation(),clearTimeout(m(l,nt)),document.querySelector("#scene-navigation").classList.add("expanded")}),T(l,en,e=>{f.log("TopNavigation mouseleave",[]),!(!l.isCollapsed||!l.showNavOnHover)&&(e.stopPropagation(),k(l,nt,setTimeout(()=>{clearTimeout(m(l,nt)),k(l,nt,null),document.querySelector("#scene-navigation").classList.remove("expanded")},700)))}),h(l,"placeNavButtons",async()=>{var c;const e=document.querySelector("#scene-navigation");if(!e)return;e.querySelector("#scene-navigation-inactive");let t=document.querySelectorAll("button.crlngn-btn");const n=((c=m(l,ht))==null?void 0:c.offsetWidth)*2||0,a=e.offsetWidth-n<e.scrollWidth;if(f.log("placeNavButtons *",[l.isCollapsed,a,t]),!a||l.isCollapsed||m(l,at).classList.contains("navigation-collapsed")){t.forEach(d=>{f.log("placeNavButtons remove",[d.remove,d]),d.remove()}),t=[];return}if(t.length>0)return;const o=await R.renderTemplate(`modules/${z}/templates/scene-nav-buttons.hbs`,{});e.insertAdjacentHTML("afterend",o);const s=document.querySelector("#ui-left button.crlngn-btn.ui-nav-left"),r=document.querySelector("#ui-left button.crlngn-btn.ui-nav-right");s&&s.addEventListener("click",m(l,Ln)),r&&r.addEventListener("click",m(l,Tn)),l.handleHide()}),T(l,Ln,async e=>{const t=await l.getItemsPerPage(),n=l.navPos||0;if(!m(l,Zt)||!m(l,W))return;let a=n-(t-1);f.log("onNavLast",["pos",a,m(l,W).scrollWidth]),a=a<0?0:a,l.setNavPosition(a)}),T(l,Tn,async e=>{var d,g;const t=await l.getItemsPerPage(),n=l.navPos||0,a=(d=m(l,W))==null?void 0:d.querySelector("li.nav-item:first-of-type"),o=(a==null?void 0:a.offsetWidth)||0,s=((g=m(l,W))==null?void 0:g.scrollWidth)||0;if(!o||!m(l,W))return;let r=n+(t-1),c=r*o;f.log("onNavNext",["pos",n,r,a==null?void 0:a.offsetWidth,c,s]),c>=s&&(r=Math.floor(s/o)),l.setNavPosition(r)}),h(l,"getItemsPerPage",async()=>{var e,t;try{f.log("getItemsPerPage",["Starting"]),l.resetLocalVars();const n=0,a=0,o=((e=m(l,ht))==null?void 0:e.offsetWidth)||0,s=(t=m(l,W))==null?void 0:t.querySelector("li.nav-item:first-of-type");if(!s||!m(l,W))return f.log("getItemsPerPage",["No scene items found"]),0;const r=s.offsetWidth,c=m(l,W).offsetWidth;if(!c)return f.log("getItemsPerPage",["Nav element has no width"]),0;const d=Math.floor((c-o*2)/r);return f.log("getItemsPerPage",["Calculated:",d,c,r]),d||0}catch(n){return f.log("getItemsPerPage",["Error:",n]),f.error("Error in getItemsPerPage:",n),0}}),h(l,"preloadTemplates",async()=>{try{const e=[`modules/${z}/templates/scene-nav-buttons.hbs`,`modules/${z}/templates/scene-nav-preview.hbs`,`modules/${z}/templates/scene-nav-toggle.hbs`];return await loadTemplates(e),!0}catch(e){return console.error("Error loading navigation button templates:",e),!1}}),h(l,"getCurrScenePosition",async e=>{try{if(!m(l,W)||!e)return 0;const t=await l.getItemsPerPage()||1,n=m(l,W).querySelectorAll("li.nav-item");if(!n||n.length===0)return 0;const o=Array.from(n).findIndex(c=>c.dataset.sceneId===e);if(o===-1)return 0;const s=o>=l.navPos&&o<=l.navPos+t,r=s?l.navPos:o;return f.log("getCurrScenePosition",["Final position:",r,"isVisible:",s]),r}catch(t){return f.log("getCurrScenePosition",["Error:",t]),console.error("Error in getCurrScenePosition:",t),0}}),h(l,"onActivateScene",e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget,a=t.classList.contains("scene-name")?t.parentNode.dataset:t.dataset,o=game.scenes.get(a.entryId||a.sceneId);f.log("onActivateScene",[a,o]),o.activate(),o.sheet.render=m(l,Oe),m(l,be)&&(clearTimeout(m(l,be)),k(l,be,null))}),h(l,"onSelectScene",e=>{var s;e.preventDefault(),e.stopPropagation();const t=e.currentTarget,n=t.classList.contains("scene-name"),a=n?t.parentNode.dataset:t.dataset,o=game.scenes.get(a.entryId||a.sceneId);k(l,st,""),f.log("onSelectScene",[o,t,n]),o&&o.sheet&&!m(l,be)&&(k(l,Oe,(s=o==null?void 0:o.sheet)==null?void 0:s.render),f.log("onSelectScene - originalRender",[m(l,Oe)]),o.sheet.render=()=>{},setTimeout(()=>{o.sheet.render=m(l,Oe)},500)),m(l,be)&&(clearTimeout(m(l,be)),o.sheet.render=m(l,Oe),k(l,be,null)),k(l,be,setTimeout(()=>{o.view(),o.sheet.render=m(l,Oe),k(l,be,null)},350))}),h(l,"onScenePreviewOn",e=>{if(f.log("onScenePreviewOn",[]),e.preventDefault(),l.isCollapsed)return;const t=e.currentTarget,n=t.dataset;k(l,st,n.sceneId),k(l,yt,setTimeout(()=>{var a;clearTimeout(m(l,yt)),(a=t.querySelector(".scene-preview"))==null||a.classList.add("open")},200))}),h(l,"onScenePreviewOff",e=>{var n;if(f.log("onScenePreviewOff",[]),e.preventDefault(),clearTimeout(m(l,yt)),l.isCollapsed)return;const t=e.currentTarget;k(l,st,""),(n=t.querySelector(".scene-preview"))==null||n.classList.remove("open")}),h(l,"addSceneListeners",e=>{e.querySelectorAll("li.scene").forEach(n=>{var a;if(n.querySelector(".scene-name").addEventListener("click",l.onSelectScene),n.querySelector(".scene-name").addEventListener("dblclick",l.onActivateScene),n.removeEventListener("mouseenter",l.onScenePreviewOn),n.removeEventListener("mouseleave",l.onScenePreviewOff),l.useScenePreview){const o=n.dataset.sceneId,s=game.scenes.find(r=>r.id===o);(a=game.user)!=null&&a.isGM&&l.addPreviewIconListeners(n,s),n.addEventListener("mouseenter",l.onScenePreviewOn),n.addEventListener("mouseleave",l.onScenePreviewOff)}})}),h(l,"addPreviewIconListeners",(e,t)=>{if(!e||!t)return;const n=game.scenes.get(t.id);if(!n)return;const a=e.querySelector(".scene-preview");if(!a)return;const o=a.querySelector(".ilum");o&&o.addEventListener("click",m(l,kn));const s=a.querySelector(".token-vision");s&&s.addEventListener("click",m(l,On));const r=a.querySelector(".sound");r&&n.playlistSound&&r.addEventListener("click",m(l,In));const c=a.querySelector(".preload");c&&c.addEventListener("click",m(l,Rn));const d=a.querySelector(".config");d&&d.addEventListener("click",m(l,wn))}),T(l,wn,e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget.closest("li.scene");l.getSceneFromElement(t).sheet.render(!0),f.log("Opened scene configuration")}),T(l,Rn,e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget.closest("li.scene"),n=l.getSceneFromElement(t);game.scenes.preload(n.id,!0),f.log("Preloaded scene")}),T(l,In,async e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget.closest("li.scene");let n=l.getSceneFromElement(t);const a=n.playlistSound;if(a){const o=a.sound.playing;o?a.sound.pause():a.sound.play(),await l.updateScenePreview(t,n.id),f.log("Toggled playlist sound",[!o])}}),T(l,kn,async e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget.closest("li.scene");let n=l.getSceneFromElement(t);const a=n.environment.globalLight.enabled;k(l,Ue,!0),await n.update({"environment.globalLight.enabled":!a}),await l.updateScenePreview(t,n.id),f.log("Toggled global illumination",[!a])}),T(l,On,async e=>{e.stopPropagation(),e.preventDefault();const t=e.currentTarget.closest("li.scene");let n=l.getSceneFromElement(t);const a=n.tokenVision;k(l,Ue,!0),await n.update({tokenVision:!a}),await l.updateScenePreview(t,n.id),f.log("Toggled token vision",[!a])}),h(l,"getSceneFromElement",e=>{const t=e.dataset.sceneId;return game.scenes.get(t)}),h(l,"updateScenePreview",async(e,t)=>{var d,g,p,y;if(!l.sceneNavEnabled||!e||!t)return;const n=game.scenes.get(t);if(!n)return;const a=e.querySelector(".scene-preview");if(!a)return;const o=a.classList.contains("open");f.log("Scene data for preview",[t,(g=(d=n.environment)==null?void 0:d.globalLight)==null?void 0:g.enabled,n.tokenVision]);const s={id:n.id,name:n.name,thumb:n.thumb||"",environment:n.environment,tokenVision:n.tokenVision,isGM:(p=game.user)==null?void 0:p.isGM},r=await R.renderTemplate(`modules/${z}/templates/scene-nav-preview.hbs`,s);a.outerHTML=r;const c=e.querySelector(".scene-preview");o&&c&&c.classList.add("open"),l.sceneNavEnabled&&l.useScenePreview&&(e.removeEventListener("mouseenter",l.onScenePreviewOn),e.removeEventListener("mouseleave",l.onScenePreviewOff),e.addEventListener("mouseenter",l.onScenePreviewOn),e.addEventListener("mouseleave",l.onScenePreviewOff),(y=game.user)!=null&&y.isGM&&l.addPreviewIconListeners(e,s))}),h(l,"applySceneItemWidth",()=>{const e=w(),t=E.get(e.sceneItemWidth.tag)||150;R.addCSSVars("--scene-nav-item-width",`${t}px`)});let P=l;/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */function ma(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);e&&(n=n.filter(function(a){return Object.getOwnPropertyDescriptor(i,a).enumerable})),t.push.apply(t,n)}return t}function Re(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ma(Object(t),!0).forEach(function(n){no(i,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):ma(Object(t)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(t,n))})}return i}function dn(i){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?dn=function(e){return typeof e}:dn=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},dn(i)}function no(i,e,t){return e in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}function De(){return De=Object.assign||function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(i[n]=t[n])}return i},De.apply(this,arguments)}function ao(i,e){if(i==null)return{};var t={},n=Object.keys(i),a,o;for(o=0;o<n.length;o++)a=n[o],!(e.indexOf(a)>=0)&&(t[a]=i[a]);return t}function oo(i,e){if(i==null)return{};var t=ao(i,e),n,a;if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(i);for(a=0;a<o.length;a++)n=o[a],!(e.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(i,n)&&(t[n]=i[n])}return t}var so="1.15.6";function Fe(i){if(typeof window<"u"&&window.navigator)return!!navigator.userAgent.match(i)}var Me=Fe(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),tn=Fe(/Edge/i),ha=Fe(/firefox/i),Ft=Fe(/safari/i)&&!Fe(/chrome/i)&&!Fe(/android/i),ra=Fe(/iP(ad|od|hone)/i),Oa=Fe(/chrome/i)&&Fe(/android/i),Fa={capture:!1,passive:!1};function H(i,e,t){i.addEventListener(e,t,!Me&&Fa)}function q(i,e,t){i.removeEventListener(e,t,!Me&&Fa)}function hn(i,e){if(e){if(e[0]===">"&&(e=e.substring(1)),i)try{if(i.matches)return i.matches(e);if(i.msMatchesSelector)return i.msMatchesSelector(e);if(i.webkitMatchesSelector)return i.webkitMatchesSelector(e)}catch{return!1}return!1}}function Da(i){return i.host&&i!==document&&i.host.nodeType?i.host:i.parentNode}function Ne(i,e,t,n){if(i){t=t||document;do{if(e!=null&&(e[0]===">"?i.parentNode===t&&hn(i,e):hn(i,e))||n&&i===t)return i;if(i===t)break}while(i=Da(i))}return null}var ya=/\s+/g;function pe(i,e,t){if(i&&e)if(i.classList)i.classList[t?"add":"remove"](e);else{var n=(" "+i.className+" ").replace(ya," ").replace(" "+e+" "," ");i.className=(n+(t?" "+e:"")).replace(ya," ")}}function F(i,e,t){var n=i&&i.style;if(n){if(t===void 0)return document.defaultView&&document.defaultView.getComputedStyle?t=document.defaultView.getComputedStyle(i,""):i.currentStyle&&(t=i.currentStyle),e===void 0?t:t[e];!(e in n)&&e.indexOf("webkit")===-1&&(e="-webkit-"+e),n[e]=t+(typeof t=="string"?"":"px")}}function ft(i,e){var t="";if(typeof i=="string")t=i;else do{var n=F(i,"transform");n&&n!=="none"&&(t=n+" "+t)}while(!e&&(i=i.parentNode));var a=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return a&&new a(t)}function Ma(i,e,t){if(i){var n=i.getElementsByTagName(e),a=0,o=n.length;if(t)for(;a<o;a++)t(n[a],a);return n}return[]}function we(){var i=document.scrollingElement;return i||document.documentElement}function Q(i,e,t,n,a){if(!(!i.getBoundingClientRect&&i!==window)){var o,s,r,c,d,g,p;if(i!==window&&i.parentNode&&i!==we()?(o=i.getBoundingClientRect(),s=o.top,r=o.left,c=o.bottom,d=o.right,g=o.height,p=o.width):(s=0,r=0,c=window.innerHeight,d=window.innerWidth,g=window.innerHeight,p=window.innerWidth),(e||t)&&i!==window&&(a=a||i.parentNode,!Me))do if(a&&a.getBoundingClientRect&&(F(a,"transform")!=="none"||t&&F(a,"position")!=="static")){var y=a.getBoundingClientRect();s-=y.top+parseInt(F(a,"border-top-width")),r-=y.left+parseInt(F(a,"border-left-width")),c=s+o.height,d=r+o.width;break}while(a=a.parentNode);if(n&&i!==window){var C=ft(a||i),L=C&&C.a,O=C&&C.d;C&&(s/=O,r/=L,p/=L,g/=O,c=s+g,d=r+p)}return{top:s,left:r,bottom:c,right:d,width:p,height:g}}}function ba(i,e,t){for(var n=Ve(i,!0),a=Q(i)[e];n;){var o=Q(n)[t],s=void 0;if(s=a>=o,!s)return n;if(n===we())break;n=Ve(n,!1)}return!1}function Ct(i,e,t,n){for(var a=0,o=0,s=i.children;o<s.length;){if(s[o].style.display!=="none"&&s[o]!==D.ghost&&(n||s[o]!==D.dragged)&&Ne(s[o],t.draggable,i,!1)){if(a===e)return s[o];a++}o++}return null}function la(i,e){for(var t=i.lastElementChild;t&&(t===D.ghost||F(t,"display")==="none"||e&&!hn(t,e));)t=t.previousElementSibling;return t||null}function ye(i,e){var t=0;if(!i||!i.parentNode)return-1;for(;i=i.previousElementSibling;)i.nodeName.toUpperCase()!=="TEMPLATE"&&i!==D.clone&&(!e||hn(i,e))&&t++;return t}function Sa(i){var e=0,t=0,n=we();if(i)do{var a=ft(i),o=a.a,s=a.d;e+=i.scrollLeft*o,t+=i.scrollTop*s}while(i!==n&&(i=i.parentNode));return[e,t]}function io(i,e){for(var t in i)if(i.hasOwnProperty(t)){for(var n in e)if(e.hasOwnProperty(n)&&e[n]===i[t][n])return Number(t)}return-1}function Ve(i,e){if(!i||!i.getBoundingClientRect)return we();var t=i,n=!1;do if(t.clientWidth<t.scrollWidth||t.clientHeight<t.scrollHeight){var a=F(t);if(t.clientWidth<t.scrollWidth&&(a.overflowX=="auto"||a.overflowX=="scroll")||t.clientHeight<t.scrollHeight&&(a.overflowY=="auto"||a.overflowY=="scroll")){if(!t.getBoundingClientRect||t===document.body)return we();if(n||e)return t;n=!0}}while(t=t.parentNode);return we()}function ro(i,e){if(i&&e)for(var t in e)e.hasOwnProperty(t)&&(i[t]=e[t]);return i}function zn(i,e){return Math.round(i.top)===Math.round(e.top)&&Math.round(i.left)===Math.round(e.left)&&Math.round(i.height)===Math.round(e.height)&&Math.round(i.width)===Math.round(e.width)}var Dt;function Pa(i,e){return function(){if(!Dt){var t=arguments,n=this;t.length===1?i.call(n,t[0]):i.apply(n,t),Dt=setTimeout(function(){Dt=void 0},e)}}}function lo(){clearTimeout(Dt),Dt=void 0}function Aa(i,e,t){i.scrollLeft+=e,i.scrollTop+=t}function Ga(i){var e=window.Polymer,t=window.jQuery||window.Zepto;return e&&e.dom?e.dom(i).cloneNode(!0):t?t(i).clone(!0)[0]:i.cloneNode(!0)}function za(i,e,t){var n={};return Array.from(i.children).forEach(function(a){var o,s,r,c;if(!(!Ne(a,e.draggable,i,!1)||a.animated||a===t)){var d=Q(a);n.left=Math.min((o=n.left)!==null&&o!==void 0?o:1/0,d.left),n.top=Math.min((s=n.top)!==null&&s!==void 0?s:1/0,d.top),n.right=Math.max((r=n.right)!==null&&r!==void 0?r:-1/0,d.right),n.bottom=Math.max((c=n.bottom)!==null&&c!==void 0?c:-1/0,d.bottom)}}),n.width=n.right-n.left,n.height=n.bottom-n.top,n.x=n.left,n.y=n.top,n}var de="Sortable"+new Date().getTime();function co(){var i=[],e;return{captureAnimationState:function(){if(i=[],!!this.options.animation){var n=[].slice.call(this.el.children);n.forEach(function(a){if(!(F(a,"display")==="none"||a===D.ghost)){i.push({target:a,rect:Q(a)});var o=Re({},i[i.length-1].rect);if(a.thisAnimationDuration){var s=ft(a,!0);s&&(o.top-=s.f,o.left-=s.e)}a.fromRect=o}})}},addAnimationState:function(n){i.push(n)},removeAnimationState:function(n){i.splice(io(i,{target:n}),1)},animateAll:function(n){var a=this;if(!this.options.animation){clearTimeout(e),typeof n=="function"&&n();return}var o=!1,s=0;i.forEach(function(r){var c=0,d=r.target,g=d.fromRect,p=Q(d),y=d.prevFromRect,C=d.prevToRect,L=r.rect,O=ft(d,!0);O&&(p.top-=O.f,p.left-=O.e),d.toRect=p,d.thisAnimationDuration&&zn(y,p)&&!zn(g,p)&&(L.top-p.top)/(L.left-p.left)===(g.top-p.top)/(g.left-p.left)&&(c=go(L,y,C,a.options)),zn(p,g)||(d.prevFromRect=g,d.prevToRect=p,c||(c=a.options.animation),a.animate(d,L,p,c)),c&&(o=!0,s=Math.max(s,c),clearTimeout(d.animationResetTimer),d.animationResetTimer=setTimeout(function(){d.animationTime=0,d.prevFromRect=null,d.fromRect=null,d.prevToRect=null,d.thisAnimationDuration=null},c),d.thisAnimationDuration=c)}),clearTimeout(e),o?e=setTimeout(function(){typeof n=="function"&&n()},s):typeof n=="function"&&n(),i=[]},animate:function(n,a,o,s){if(s){F(n,"transition",""),F(n,"transform","");var r=ft(this.el),c=r&&r.a,d=r&&r.d,g=(a.left-o.left)/(c||1),p=(a.top-o.top)/(d||1);n.animatingX=!!g,n.animatingY=!!p,F(n,"transform","translate3d("+g+"px,"+p+"px,0)"),this.forRepaintDummy=uo(n),F(n,"transition","transform "+s+"ms"+(this.options.easing?" "+this.options.easing:"")),F(n,"transform","translate3d(0,0,0)"),typeof n.animated=="number"&&clearTimeout(n.animated),n.animated=setTimeout(function(){F(n,"transition",""),F(n,"transform",""),n.animated=!1,n.animatingX=!1,n.animatingY=!1},s)}}}}function uo(i){return i.offsetWidth}function go(i,e,t,n){return Math.sqrt(Math.pow(e.top-i.top,2)+Math.pow(e.left-i.left,2))/Math.sqrt(Math.pow(e.top-t.top,2)+Math.pow(e.left-t.left,2))*n.animation}var rt=[],qn={initializeByDefault:!0},nn={mount:function(e){for(var t in qn)qn.hasOwnProperty(t)&&!(t in e)&&(e[t]=qn[t]);rt.forEach(function(n){if(n.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),rt.push(e)},pluginEvent:function(e,t,n){var a=this;this.eventCanceled=!1,n.cancel=function(){a.eventCanceled=!0};var o=e+"Global";rt.forEach(function(s){t[s.pluginName]&&(t[s.pluginName][o]&&t[s.pluginName][o](Re({sortable:t},n)),t.options[s.pluginName]&&t[s.pluginName][e]&&t[s.pluginName][e](Re({sortable:t},n)))})},initializePlugins:function(e,t,n,a){rt.forEach(function(r){var c=r.pluginName;if(!(!e.options[c]&&!r.initializeByDefault)){var d=new r(e,t,e.options);d.sortable=e,d.options=e.options,e[c]=d,De(n,d.defaults)}});for(var o in e.options)if(e.options.hasOwnProperty(o)){var s=this.modifyOption(e,o,e.options[o]);typeof s<"u"&&(e.options[o]=s)}},getEventProperties:function(e,t){var n={};return rt.forEach(function(a){typeof a.eventProperties=="function"&&De(n,a.eventProperties.call(t[a.pluginName],e))}),n},modifyOption:function(e,t,n){var a;return rt.forEach(function(o){e[o.pluginName]&&o.optionListeners&&typeof o.optionListeners[t]=="function"&&(a=o.optionListeners[t].call(e[o.pluginName],n))}),a}};function fo(i){var e=i.sortable,t=i.rootEl,n=i.name,a=i.targetEl,o=i.cloneEl,s=i.toEl,r=i.fromEl,c=i.oldIndex,d=i.newIndex,g=i.oldDraggableIndex,p=i.newDraggableIndex,y=i.originalEvent,C=i.putSortable,L=i.extraEventProperties;if(e=e||t&&t[de],!!e){var O,$=e.options,te="on"+n.charAt(0).toUpperCase()+n.substr(1);window.CustomEvent&&!Me&&!tn?O=new CustomEvent(n,{bubbles:!0,cancelable:!0}):(O=document.createEvent("Event"),O.initEvent(n,!0,!0)),O.to=s||t,O.from=r||t,O.item=a||t,O.clone=o,O.oldIndex=c,O.newIndex=d,O.oldDraggableIndex=g,O.newDraggableIndex=p,O.originalEvent=y,O.pullMode=C?C.lastPutMode:void 0;var re=Re(Re({},L),nn.getEventProperties(n,e));for(var ve in re)O[ve]=re[ve];t&&t.dispatchEvent(O),$[te]&&$[te].call(e,O)}}var po=["evt"],ce=function(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},a=n.evt,o=oo(n,po);nn.pluginEvent.bind(D)(e,t,Re({dragEl:S,parentEl:X,ghostEl:M,rootEl:V,nextEl:Ze,lastDownEl:un,cloneEl:Y,cloneHidden:qe,dragStarted:It,putSortable:ae,activeSortable:D.active,originalEvent:a,oldIndex:dt,oldDraggableIndex:Mt,newIndex:me,newDraggableIndex:Ge,hideGhostForTarget:xa,unhideGhostForTarget:Ua,cloneNowHidden:function(){qe=!0},cloneNowShown:function(){qe=!1},dispatchSortableEvent:function(r){le({sortable:t,name:r,originalEvent:a})}},o))};function le(i){fo(Re({putSortable:ae,cloneEl:Y,targetEl:S,rootEl:V,oldIndex:dt,oldDraggableIndex:Mt,newIndex:me,newDraggableIndex:Ge},i))}var S,X,M,V,Ze,un,Y,qe,dt,me,Mt,Ge,sn,ae,ct=!1,yn=!1,bn=[],Xe,Ce,Hn,Bn,va,Ca,It,lt,Pt,At=!1,rn=!1,gn,se,xn=[],Kn=!1,Sn=[],Pn=typeof document<"u",ln=ra,Ea=tn||Me?"cssFloat":"float",mo=Pn&&!Oa&&!ra&&"draggable"in document.createElement("div"),qa=function(){if(Pn){if(Me)return!1;var i=document.createElement("x");return i.style.cssText="pointer-events:auto",i.style.pointerEvents==="auto"}}(),Ha=function(e,t){var n=F(e),a=parseInt(n.width)-parseInt(n.paddingLeft)-parseInt(n.paddingRight)-parseInt(n.borderLeftWidth)-parseInt(n.borderRightWidth),o=Ct(e,0,t),s=Ct(e,1,t),r=o&&F(o),c=s&&F(s),d=r&&parseInt(r.marginLeft)+parseInt(r.marginRight)+Q(o).width,g=c&&parseInt(c.marginLeft)+parseInt(c.marginRight)+Q(s).width;if(n.display==="flex")return n.flexDirection==="column"||n.flexDirection==="column-reverse"?"vertical":"horizontal";if(n.display==="grid")return n.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(o&&r.float&&r.float!=="none"){var p=r.float==="left"?"left":"right";return s&&(c.clear==="both"||c.clear===p)?"vertical":"horizontal"}return o&&(r.display==="block"||r.display==="flex"||r.display==="table"||r.display==="grid"||d>=a&&n[Ea]==="none"||s&&n[Ea]==="none"&&d+g>a)?"vertical":"horizontal"},ho=function(e,t,n){var a=n?e.left:e.top,o=n?e.right:e.bottom,s=n?e.width:e.height,r=n?t.left:t.top,c=n?t.right:t.bottom,d=n?t.width:t.height;return a===r||o===c||a+s/2===r+d/2},yo=function(e,t){var n;return bn.some(function(a){var o=a[de].options.emptyInsertThreshold;if(!(!o||la(a))){var s=Q(a),r=e>=s.left-o&&e<=s.right+o,c=t>=s.top-o&&t<=s.bottom+o;if(r&&c)return n=a}}),n},Ba=function(e){function t(o,s){return function(r,c,d,g){var p=r.options.group.name&&c.options.group.name&&r.options.group.name===c.options.group.name;if(o==null&&(s||p))return!0;if(o==null||o===!1)return!1;if(s&&o==="clone")return o;if(typeof o=="function")return t(o(r,c,d,g),s)(r,c,d,g);var y=(s?r:c).options.group.name;return o===!0||typeof o=="string"&&o===y||o.join&&o.indexOf(y)>-1}}var n={},a=e.group;(!a||dn(a)!="object")&&(a={name:a}),n.name=a.name,n.checkPull=t(a.pull,!0),n.checkPut=t(a.put),n.revertClone=a.revertClone,e.group=n},xa=function(){!qa&&M&&F(M,"display","none")},Ua=function(){!qa&&M&&F(M,"display","")};Pn&&!Oa&&document.addEventListener("click",function(i){if(yn)return i.preventDefault(),i.stopPropagation&&i.stopPropagation(),i.stopImmediatePropagation&&i.stopImmediatePropagation(),yn=!1,!1},!0);var Je=function(e){if(S){e=e.touches?e.touches[0]:e;var t=yo(e.clientX,e.clientY);if(t){var n={};for(var a in e)e.hasOwnProperty(a)&&(n[a]=e[a]);n.target=n.rootEl=t,n.preventDefault=void 0,n.stopPropagation=void 0,t[de]._onDragOver(n)}}},bo=function(e){S&&S.parentNode[de]._isOutsideThisEl(e.target)};function D(i,e){if(!(i&&i.nodeType&&i.nodeType===1))throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(i));this.el=i,this.options=e=De({},e),i[de]=this;var t={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(i.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return Ha(i,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(s,r){s.setData("Text",r.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:D.supportPointer!==!1&&"PointerEvent"in window&&(!Ft||ra),emptyInsertThreshold:5};nn.initializePlugins(this,i,t);for(var n in t)!(n in e)&&(e[n]=t[n]);Ba(e);for(var a in this)a.charAt(0)==="_"&&typeof this[a]=="function"&&(this[a]=this[a].bind(this));this.nativeDraggable=e.forceFallback?!1:mo,this.nativeDraggable&&(this.options.touchStartThreshold=1),e.supportPointer?H(i,"pointerdown",this._onTapStart):(H(i,"mousedown",this._onTapStart),H(i,"touchstart",this._onTapStart)),this.nativeDraggable&&(H(i,"dragover",this),H(i,"dragenter",this)),bn.push(this.el),e.store&&e.store.get&&this.sort(e.store.get(this)||[]),De(this,co())}D.prototype={constructor:D,_isOutsideThisEl:function(e){!this.el.contains(e)&&e!==this.el&&(lt=null)},_getDirection:function(e,t){return typeof this.options.direction=="function"?this.options.direction.call(this,e,t,S):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,n=this.el,a=this.options,o=a.preventOnFilter,s=e.type,r=e.touches&&e.touches[0]||e.pointerType&&e.pointerType==="touch"&&e,c=(r||e).target,d=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||c,g=a.filter;if(wo(n),!S&&!(/mousedown|pointerdown/.test(s)&&e.button!==0||a.disabled)&&!d.isContentEditable&&!(!this.nativeDraggable&&Ft&&c&&c.tagName.toUpperCase()==="SELECT")&&(c=Ne(c,a.draggable,n,!1),!(c&&c.animated)&&un!==c)){if(dt=ye(c),Mt=ye(c,a.draggable),typeof g=="function"){if(g.call(this,e,c,this)){le({sortable:t,rootEl:d,name:"filter",targetEl:c,toEl:n,fromEl:n}),ce("filter",t,{evt:e}),o&&e.preventDefault();return}}else if(g&&(g=g.split(",").some(function(p){if(p=Ne(d,p.trim(),n,!1),p)return le({sortable:t,rootEl:p,name:"filter",targetEl:c,fromEl:n,toEl:n}),ce("filter",t,{evt:e}),!0}),g)){o&&e.preventDefault();return}a.handle&&!Ne(d,a.handle,n,!1)||this._prepareDragStart(e,r,c)}}},_prepareDragStart:function(e,t,n){var a=this,o=a.el,s=a.options,r=o.ownerDocument,c;if(n&&!S&&n.parentNode===o){var d=Q(n);if(V=o,S=n,X=S.parentNode,Ze=S.nextSibling,un=n,sn=s.group,D.dragged=S,Xe={target:S,clientX:(t||e).clientX,clientY:(t||e).clientY},va=Xe.clientX-d.left,Ca=Xe.clientY-d.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,S.style["will-change"]="all",c=function(){if(ce("delayEnded",a,{evt:e}),D.eventCanceled){a._onDrop();return}a._disableDelayedDragEvents(),!ha&&a.nativeDraggable&&(S.draggable=!0),a._triggerDragStart(e,t),le({sortable:a,name:"choose",originalEvent:e}),pe(S,s.chosenClass,!0)},s.ignore.split(",").forEach(function(g){Ma(S,g.trim(),Un)}),H(r,"dragover",Je),H(r,"mousemove",Je),H(r,"touchmove",Je),s.supportPointer?(H(r,"pointerup",a._onDrop),!this.nativeDraggable&&H(r,"pointercancel",a._onDrop)):(H(r,"mouseup",a._onDrop),H(r,"touchend",a._onDrop),H(r,"touchcancel",a._onDrop)),ha&&this.nativeDraggable&&(this.options.touchStartThreshold=4,S.draggable=!0),ce("delayStart",this,{evt:e}),s.delay&&(!s.delayOnTouchOnly||t)&&(!this.nativeDraggable||!(tn||Me))){if(D.eventCanceled){this._onDrop();return}s.supportPointer?(H(r,"pointerup",a._disableDelayedDrag),H(r,"pointercancel",a._disableDelayedDrag)):(H(r,"mouseup",a._disableDelayedDrag),H(r,"touchend",a._disableDelayedDrag),H(r,"touchcancel",a._disableDelayedDrag)),H(r,"mousemove",a._delayedDragTouchMoveHandler),H(r,"touchmove",a._delayedDragTouchMoveHandler),s.supportPointer&&H(r,"pointermove",a._delayedDragTouchMoveHandler),a._dragStartTimer=setTimeout(c,s.delay)}else c()}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){S&&Un(S),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;q(e,"mouseup",this._disableDelayedDrag),q(e,"touchend",this._disableDelayedDrag),q(e,"touchcancel",this._disableDelayedDrag),q(e,"pointerup",this._disableDelayedDrag),q(e,"pointercancel",this._disableDelayedDrag),q(e,"mousemove",this._delayedDragTouchMoveHandler),q(e,"touchmove",this._delayedDragTouchMoveHandler),q(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||e.pointerType=="touch"&&e,!this.nativeDraggable||t?this.options.supportPointer?H(document,"pointermove",this._onTouchMove):t?H(document,"touchmove",this._onTouchMove):H(document,"mousemove",this._onTouchMove):(H(S,"dragend",this),H(V,"dragstart",this._onDragStart));try{document.selection?fn(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch{}},_dragStarted:function(e,t){if(ct=!1,V&&S){ce("dragStarted",this,{evt:t}),this.nativeDraggable&&H(document,"dragover",bo);var n=this.options;!e&&pe(S,n.dragClass,!1),pe(S,n.ghostClass,!0),D.active=this,e&&this._appendGhost(),le({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if(Ce){this._lastX=Ce.clientX,this._lastY=Ce.clientY,xa();for(var e=document.elementFromPoint(Ce.clientX,Ce.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(Ce.clientX,Ce.clientY),e!==t);)t=e;if(S.parentNode[de]._isOutsideThisEl(e),t)do{if(t[de]){var n=void 0;if(n=t[de]._onDragOver({clientX:Ce.clientX,clientY:Ce.clientY,target:e,rootEl:t}),n&&!this.options.dragoverBubble)break}e=t}while(t=Da(t));Ua()}},_onTouchMove:function(e){if(Xe){var t=this.options,n=t.fallbackTolerance,a=t.fallbackOffset,o=e.touches?e.touches[0]:e,s=M&&ft(M,!0),r=M&&s&&s.a,c=M&&s&&s.d,d=ln&&se&&Sa(se),g=(o.clientX-Xe.clientX+a.x)/(r||1)+(d?d[0]-xn[0]:0)/(r||1),p=(o.clientY-Xe.clientY+a.y)/(c||1)+(d?d[1]-xn[1]:0)/(c||1);if(!D.active&&!ct){if(n&&Math.max(Math.abs(o.clientX-this._lastX),Math.abs(o.clientY-this._lastY))<n)return;this._onDragStart(e,!0)}if(M){s?(s.e+=g-(Hn||0),s.f+=p-(Bn||0)):s={a:1,b:0,c:0,d:1,e:g,f:p};var y="matrix(".concat(s.a,",").concat(s.b,",").concat(s.c,",").concat(s.d,",").concat(s.e,",").concat(s.f,")");F(M,"webkitTransform",y),F(M,"mozTransform",y),F(M,"msTransform",y),F(M,"transform",y),Hn=g,Bn=p,Ce=o}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!M){var e=this.options.fallbackOnBody?document.body:V,t=Q(S,!0,ln,!0,e),n=this.options;if(ln){for(se=e;F(se,"position")==="static"&&F(se,"transform")==="none"&&se!==document;)se=se.parentNode;se!==document.body&&se!==document.documentElement?(se===document&&(se=we()),t.top+=se.scrollTop,t.left+=se.scrollLeft):se=we(),xn=Sa(se)}M=S.cloneNode(!0),pe(M,n.ghostClass,!1),pe(M,n.fallbackClass,!0),pe(M,n.dragClass,!0),F(M,"transition",""),F(M,"transform",""),F(M,"box-sizing","border-box"),F(M,"margin",0),F(M,"top",t.top),F(M,"left",t.left),F(M,"width",t.width),F(M,"height",t.height),F(M,"opacity","0.8"),F(M,"position",ln?"absolute":"fixed"),F(M,"zIndex","100000"),F(M,"pointerEvents","none"),D.ghost=M,e.appendChild(M),F(M,"transform-origin",va/parseInt(M.style.width)*100+"% "+Ca/parseInt(M.style.height)*100+"%")}},_onDragStart:function(e,t){var n=this,a=e.dataTransfer,o=n.options;if(ce("dragStart",this,{evt:e}),D.eventCanceled){this._onDrop();return}ce("setupClone",this),D.eventCanceled||(Y=Ga(S),Y.removeAttribute("id"),Y.draggable=!1,Y.style["will-change"]="",this._hideClone(),pe(Y,this.options.chosenClass,!1),D.clone=Y),n.cloneId=fn(function(){ce("clone",n),!D.eventCanceled&&(n.options.removeCloneOnHide||V.insertBefore(Y,S),n._hideClone(),le({sortable:n,name:"clone"}))}),!t&&pe(S,o.dragClass,!0),t?(yn=!0,n._loopId=setInterval(n._emulateDragOver,50)):(q(document,"mouseup",n._onDrop),q(document,"touchend",n._onDrop),q(document,"touchcancel",n._onDrop),a&&(a.effectAllowed="move",o.setData&&o.setData.call(n,a,S)),H(document,"drop",n),F(S,"transform","translateZ(0)")),ct=!0,n._dragStartId=fn(n._dragStarted.bind(n,t,e)),H(document,"selectstart",n),It=!0,window.getSelection().removeAllRanges(),Ft&&F(document.body,"user-select","none")},_onDragOver:function(e){var t=this.el,n=e.target,a,o,s,r=this.options,c=r.group,d=D.active,g=sn===c,p=r.sort,y=ae||d,C,L=this,O=!1;if(Kn)return;function $(wt,Ja){ce(wt,L,Re({evt:e,isOwner:g,axis:C?"vertical":"horizontal",revert:s,dragRect:a,targetRect:o,canSort:p,fromSortable:y,target:n,completed:re,onMove:function(ua,Ka){return cn(V,t,S,a,ua,Q(ua),e,Ka)},changed:ve},Ja))}function te(){$("dragOverAnimationCapture"),L.captureAnimationState(),L!==y&&y.captureAnimationState()}function re(wt){return $("dragOverCompleted",{insertion:wt}),wt&&(g?d._hideClone():d._showClone(L),L!==y&&(pe(S,ae?ae.options.ghostClass:d.options.ghostClass,!1),pe(S,r.ghostClass,!0)),ae!==L&&L!==D.active?ae=L:L===D.active&&ae&&(ae=null),y===L&&(L._ignoreWhileAnimating=n),L.animateAll(function(){$("dragOverAnimationComplete"),L._ignoreWhileAnimating=null}),L!==y&&(y.animateAll(),y._ignoreWhileAnimating=null)),(n===S&&!S.animated||n===t&&!n.animated)&&(lt=null),!r.dragoverBubble&&!e.rootEl&&n!==document&&(S.parentNode[de]._isOutsideThisEl(e.target),!wt&&Je(e)),!r.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),O=!0}function ve(){me=ye(S),Ge=ye(S,r.draggable),le({sortable:L,name:"change",toEl:t,newIndex:me,newDraggableIndex:Ge,originalEvent:e})}if(e.preventDefault!==void 0&&e.cancelable&&e.preventDefault(),n=Ne(n,r.draggable,t,!0),$("dragOver"),D.eventCanceled)return O;if(S.contains(e.target)||n.animated&&n.animatingX&&n.animatingY||L._ignoreWhileAnimating===n)return re(!1);if(yn=!1,d&&!r.disabled&&(g?p||(s=X!==V):ae===this||(this.lastPutMode=sn.checkPull(this,d,S,e))&&c.checkPut(this,d,S,e))){if(C=this._getDirection(e,n)==="vertical",a=Q(S),$("dragOverValid"),D.eventCanceled)return O;if(s)return X=V,te(),this._hideClone(),$("revert"),D.eventCanceled||(Ze?V.insertBefore(S,Ze):V.appendChild(S)),re(!0);var ge=la(t,r.draggable);if(!ge||Eo(e,C,this)&&!ge.animated){if(ge===S)return re(!1);if(ge&&t===e.target&&(n=ge),n&&(o=Q(n)),cn(V,t,S,a,n,o,e,!!n)!==!1)return te(),ge&&ge.nextSibling?t.insertBefore(S,ge.nextSibling):t.appendChild(S),X=t,ve(),re(!0)}else if(ge&&Co(e,C,this)){var je=Ct(t,0,r,!0);if(je===S)return re(!1);if(n=je,o=Q(n),cn(V,t,S,a,n,o,e,!1)!==!1)return te(),t.insertBefore(S,je),X=t,ve(),re(!0)}else if(n.parentNode===t){o=Q(n);var Le=0,Ye,Et=S.parentNode!==t,fe=!ho(S.animated&&S.toRect||a,n.animated&&n.toRect||o,C),Nt=C?"top":"left",Pe=ba(n,"top","top")||ba(S,"top","top"),Lt=Pe?Pe.scrollTop:void 0;lt!==n&&(Ye=o[Nt],At=!1,rn=!fe&&r.invertSwap||Et),Le=No(e,n,o,C,fe?1:r.swapThreshold,r.invertedSwapThreshold==null?r.swapThreshold:r.invertedSwapThreshold,rn,lt===n);var Ie;if(Le!==0){var $e=ye(S);do $e-=Le,Ie=X.children[$e];while(Ie&&(F(Ie,"display")==="none"||Ie===M))}if(Le===0||Ie===n)return re(!1);lt=n,Pt=Le;var Tt=n.nextElementSibling,Ae=!1;Ae=Le===1;var an=cn(V,t,S,a,n,o,e,Ae);if(an!==!1)return(an===1||an===-1)&&(Ae=an===1),Kn=!0,setTimeout(vo,30),te(),Ae&&!Tt?t.appendChild(S):n.parentNode.insertBefore(S,Ae?Tt:n),Pe&&Aa(Pe,0,Lt-Pe.scrollTop),X=S.parentNode,Ye!==void 0&&!rn&&(gn=Math.abs(Ye-Q(n)[Nt])),ve(),re(!0)}if(t.contains(S))return re(!1)}return!1},_ignoreWhileAnimating:null,_offMoveEvents:function(){q(document,"mousemove",this._onTouchMove),q(document,"touchmove",this._onTouchMove),q(document,"pointermove",this._onTouchMove),q(document,"dragover",Je),q(document,"mousemove",Je),q(document,"touchmove",Je)},_offUpEvents:function(){var e=this.el.ownerDocument;q(e,"mouseup",this._onDrop),q(e,"touchend",this._onDrop),q(e,"pointerup",this._onDrop),q(e,"pointercancel",this._onDrop),q(e,"touchcancel",this._onDrop),q(document,"selectstart",this)},_onDrop:function(e){var t=this.el,n=this.options;if(me=ye(S),Ge=ye(S,n.draggable),ce("drop",this,{evt:e}),X=S&&S.parentNode,me=ye(S),Ge=ye(S,n.draggable),D.eventCanceled){this._nulling();return}ct=!1,rn=!1,At=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),Zn(this.cloneId),Zn(this._dragStartId),this.nativeDraggable&&(q(document,"drop",this),q(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),Ft&&F(document.body,"user-select",""),F(S,"transform",""),e&&(It&&(e.cancelable&&e.preventDefault(),!n.dropBubble&&e.stopPropagation()),M&&M.parentNode&&M.parentNode.removeChild(M),(V===X||ae&&ae.lastPutMode!=="clone")&&Y&&Y.parentNode&&Y.parentNode.removeChild(Y),S&&(this.nativeDraggable&&q(S,"dragend",this),Un(S),S.style["will-change"]="",It&&!ct&&pe(S,ae?ae.options.ghostClass:this.options.ghostClass,!1),pe(S,this.options.chosenClass,!1),le({sortable:this,name:"unchoose",toEl:X,newIndex:null,newDraggableIndex:null,originalEvent:e}),V!==X?(me>=0&&(le({rootEl:X,name:"add",toEl:X,fromEl:V,originalEvent:e}),le({sortable:this,name:"remove",toEl:X,originalEvent:e}),le({rootEl:X,name:"sort",toEl:X,fromEl:V,originalEvent:e}),le({sortable:this,name:"sort",toEl:X,originalEvent:e})),ae&&ae.save()):me!==dt&&me>=0&&(le({sortable:this,name:"update",toEl:X,originalEvent:e}),le({sortable:this,name:"sort",toEl:X,originalEvent:e})),D.active&&((me==null||me===-1)&&(me=dt,Ge=Mt),le({sortable:this,name:"end",toEl:X,originalEvent:e}),this.save()))),this._nulling()},_nulling:function(){ce("nulling",this),V=S=X=M=Ze=Y=un=qe=Xe=Ce=It=me=Ge=dt=Mt=lt=Pt=ae=sn=D.dragged=D.ghost=D.clone=D.active=null,Sn.forEach(function(e){e.checked=!0}),Sn.length=Hn=Bn=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":S&&(this._onDragOver(e),So(e));break;case"selectstart":e.preventDefault();break}},toArray:function(){for(var e=[],t,n=this.el.children,a=0,o=n.length,s=this.options;a<o;a++)t=n[a],Ne(t,s.draggable,this.el,!1)&&e.push(t.getAttribute(s.dataIdAttr)||To(t));return e},sort:function(e,t){var n={},a=this.el;this.toArray().forEach(function(o,s){var r=a.children[s];Ne(r,this.options.draggable,a,!1)&&(n[o]=r)},this),t&&this.captureAnimationState(),e.forEach(function(o){n[o]&&(a.removeChild(n[o]),a.appendChild(n[o]))}),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return Ne(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var n=this.options;if(t===void 0)return n[e];var a=nn.modifyOption(this,e,t);typeof a<"u"?n[e]=a:n[e]=t,e==="group"&&Ba(n)},destroy:function(){ce("destroy",this);var e=this.el;e[de]=null,q(e,"mousedown",this._onTapStart),q(e,"touchstart",this._onTapStart),q(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(q(e,"dragover",this),q(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),function(t){t.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),bn.splice(bn.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!qe){if(ce("hideClone",this),D.eventCanceled)return;F(Y,"display","none"),this.options.removeCloneOnHide&&Y.parentNode&&Y.parentNode.removeChild(Y),qe=!0}},_showClone:function(e){if(e.lastPutMode!=="clone"){this._hideClone();return}if(qe){if(ce("showClone",this),D.eventCanceled)return;S.parentNode==V&&!this.options.group.revertClone?V.insertBefore(Y,S):Ze?V.insertBefore(Y,Ze):V.appendChild(Y),this.options.group.revertClone&&this.animate(S,Y),F(Y,"display",""),qe=!1}}};function So(i){i.dataTransfer&&(i.dataTransfer.dropEffect="move"),i.cancelable&&i.preventDefault()}function cn(i,e,t,n,a,o,s,r){var c,d=i[de],g=d.options.onMove,p;return window.CustomEvent&&!Me&&!tn?c=new CustomEvent("move",{bubbles:!0,cancelable:!0}):(c=document.createEvent("Event"),c.initEvent("move",!0,!0)),c.to=e,c.from=i,c.dragged=t,c.draggedRect=n,c.related=a||e,c.relatedRect=o||Q(e),c.willInsertAfter=r,c.originalEvent=s,i.dispatchEvent(c),g&&(p=g.call(d,c,s)),p}function Un(i){i.draggable=!1}function vo(){Kn=!1}function Co(i,e,t){var n=Q(Ct(t.el,0,t.options,!0)),a=za(t.el,t.options,M),o=10;return e?i.clientX<a.left-o||i.clientY<n.top&&i.clientX<n.right:i.clientY<a.top-o||i.clientY<n.bottom&&i.clientX<n.left}function Eo(i,e,t){var n=Q(la(t.el,t.options.draggable)),a=za(t.el,t.options,M),o=10;return e?i.clientX>a.right+o||i.clientY>n.bottom&&i.clientX>n.left:i.clientY>a.bottom+o||i.clientX>n.right&&i.clientY>n.top}function No(i,e,t,n,a,o,s,r){var c=n?i.clientY:i.clientX,d=n?t.height:t.width,g=n?t.top:t.left,p=n?t.bottom:t.right,y=!1;if(!s){if(r&&gn<d*a){if(!At&&(Pt===1?c>g+d*o/2:c<p-d*o/2)&&(At=!0),At)y=!0;else if(Pt===1?c<g+gn:c>p-gn)return-Pt}else if(c>g+d*(1-a)/2&&c<p-d*(1-a)/2)return Lo(e)}return y=y||s,y&&(c<g+d*o/2||c>p-d*o/2)?c>g+d/2?1:-1:0}function Lo(i){return ye(S)<ye(i)?1:-1}function To(i){for(var e=i.tagName+i.className+i.src+i.href+i.textContent,t=e.length,n=0;t--;)n+=e.charCodeAt(t);return n.toString(36)}function wo(i){Sn.length=0;for(var e=i.getElementsByTagName("input"),t=e.length;t--;){var n=e[t];n.checked&&Sn.push(n)}}function fn(i){return setTimeout(i,0)}function Zn(i){return clearTimeout(i)}Pn&&H(document,"touchmove",function(i){(D.active||ct)&&i.cancelable&&i.preventDefault()});D.utils={on:H,off:q,css:F,find:Ma,is:function(e,t){return!!Ne(e,t,e,!1)},extend:ro,throttle:Pa,closest:Ne,toggleClass:pe,clone:Ga,index:ye,nextTick:fn,cancelNextTick:Zn,detectDirection:Ha,getChild:Ct,expando:de};D.get=function(i){return i[de]};D.mount=function(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];e[0].constructor===Array&&(e=e[0]),e.forEach(function(n){if(!n.prototype||!n.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(n));n.utils&&(D.utils=Re(Re({},D.utils),n.utils)),nn.mount(n)})};D.create=function(i,e){return new D(i,e)};D.version=so;var Z=[],kt,Qn,_n=!1,Wn,Vn,vn,Ot;function Ro(){function i(){this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0};for(var e in this)e.charAt(0)==="_"&&typeof this[e]=="function"&&(this[e]=this[e].bind(this))}return i.prototype={dragStarted:function(t){var n=t.originalEvent;this.sortable.nativeDraggable?H(document,"dragover",this._handleAutoScroll):this.options.supportPointer?H(document,"pointermove",this._handleFallbackAutoScroll):n.touches?H(document,"touchmove",this._handleFallbackAutoScroll):H(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(t){var n=t.originalEvent;!this.options.dragOverBubble&&!n.rootEl&&this._handleAutoScroll(n)},drop:function(){this.sortable.nativeDraggable?q(document,"dragover",this._handleAutoScroll):(q(document,"pointermove",this._handleFallbackAutoScroll),q(document,"touchmove",this._handleFallbackAutoScroll),q(document,"mousemove",this._handleFallbackAutoScroll)),Na(),pn(),lo()},nulling:function(){vn=Qn=kt=_n=Ot=Wn=Vn=null,Z.length=0},_handleFallbackAutoScroll:function(t){this._handleAutoScroll(t,!0)},_handleAutoScroll:function(t,n){var a=this,o=(t.touches?t.touches[0]:t).clientX,s=(t.touches?t.touches[0]:t).clientY,r=document.elementFromPoint(o,s);if(vn=t,n||this.options.forceAutoScrollFallback||tn||Me||Ft){jn(t,this.options,r,n);var c=Ve(r,!0);_n&&(!Ot||o!==Wn||s!==Vn)&&(Ot&&Na(),Ot=setInterval(function(){var d=Ve(document.elementFromPoint(o,s),!0);d!==c&&(c=d,pn()),jn(t,a.options,d,n)},10),Wn=o,Vn=s)}else{if(!this.options.bubbleScroll||Ve(r,!0)===we()){pn();return}jn(t,this.options,Ve(r,!1),!1)}}},De(i,{pluginName:"scroll",initializeByDefault:!0})}function pn(){Z.forEach(function(i){clearInterval(i.pid)}),Z=[]}function Na(){clearInterval(Ot)}var jn=Pa(function(i,e,t,n){if(e.scroll){var a=(i.touches?i.touches[0]:i).clientX,o=(i.touches?i.touches[0]:i).clientY,s=e.scrollSensitivity,r=e.scrollSpeed,c=we(),d=!1,g;Qn!==t&&(Qn=t,pn(),kt=e.scroll,g=e.scrollFn,kt===!0&&(kt=Ve(t,!0)));var p=0,y=kt;do{var C=y,L=Q(C),O=L.top,$=L.bottom,te=L.left,re=L.right,ve=L.width,ge=L.height,je=void 0,Le=void 0,Ye=C.scrollWidth,Et=C.scrollHeight,fe=F(C),Nt=C.scrollLeft,Pe=C.scrollTop;C===c?(je=ve<Ye&&(fe.overflowX==="auto"||fe.overflowX==="scroll"||fe.overflowX==="visible"),Le=ge<Et&&(fe.overflowY==="auto"||fe.overflowY==="scroll"||fe.overflowY==="visible")):(je=ve<Ye&&(fe.overflowX==="auto"||fe.overflowX==="scroll"),Le=ge<Et&&(fe.overflowY==="auto"||fe.overflowY==="scroll"));var Lt=je&&(Math.abs(re-a)<=s&&Nt+ve<Ye)-(Math.abs(te-a)<=s&&!!Nt),Ie=Le&&(Math.abs($-o)<=s&&Pe+ge<Et)-(Math.abs(O-o)<=s&&!!Pe);if(!Z[p])for(var $e=0;$e<=p;$e++)Z[$e]||(Z[$e]={});(Z[p].vx!=Lt||Z[p].vy!=Ie||Z[p].el!==C)&&(Z[p].el=C,Z[p].vx=Lt,Z[p].vy=Ie,clearInterval(Z[p].pid),(Lt!=0||Ie!=0)&&(d=!0,Z[p].pid=setInterval((function(){n&&this.layer===0&&D.active._onTouchMove(vn);var Tt=Z[this.layer].vy?Z[this.layer].vy*r:0,Ae=Z[this.layer].vx?Z[this.layer].vx*r:0;typeof g=="function"&&g.call(D.dragged.parentNode[de],Ae,Tt,i,vn,Z[this.layer].el)!=="continue"||Aa(Z[this.layer].el,Ae,Tt)}).bind({layer:p}),24))),p++}while(e.bubbleScroll&&y!==c&&(y=Ve(y,!1)));_n=d}},30),Wa=function(e){var t=e.originalEvent,n=e.putSortable,a=e.dragEl,o=e.activeSortable,s=e.dispatchSortableEvent,r=e.hideGhostForTarget,c=e.unhideGhostForTarget;if(t){var d=n||o;r();var g=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,p=document.elementFromPoint(g.clientX,g.clientY);c(),d&&!d.el.contains(p)&&(s("spill"),this.onSpill({dragEl:a,putSortable:n}))}};function ca(){}ca.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,n=e.putSortable;this.sortable.captureAnimationState(),n&&n.captureAnimationState();var a=Ct(this.sortable.el,this.startIndex,this.options);a?this.sortable.el.insertBefore(t,a):this.sortable.el.appendChild(t),this.sortable.animateAll(),n&&n.animateAll()},drop:Wa};De(ca,{pluginName:"revertOnSpill"});function da(){}da.prototype={onSpill:function(e){var t=e.dragEl,n=e.putSortable,a=n||this.sortable;a.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),a.animateAll()},drop:Wa};De(da,{pluginName:"removeOnSpill"});D.mount(new Ro);D.mount(da,ca);const Yn="root";var We,_,Fn,Dn,Va;const N=class N{static init(){if(N.noFolderView()||!ui.scenes||!game.user.isGM)return;N.preloadTemplates(),game.user.getFlag(z,"activeSceneFolders")||game.user.setFlag(z,"activeSceneFolders",[]);const e=document.querySelector("#scene-navigation-inactive");((e==null?void 0:e.querySelectorAll("li.folder"))||[]).forEach(n=>{n.remove()}),Hooks.on(A.RENDER_SCENE_DIRECTORY,(n,a)=>{var o;ne(o=N,Dn,Va).call(o)})}static addFolderButtons(e,t,n){if(!P.useSceneFolders||game.scenes.size<2||game.scenes.folders.size<1)return;const a=w();if(document.querySelector("#crlngn-folder-toggle"))return;const s=t.querySelector("#scene-navigation-active");s==null||s.querySelector("li.scene");const r=`CRLNGN_UI.ui.sceneNav.${P.navShowRootFolders?"hideSceneFoldersTooltip":"showSceneFoldersTooltip"}`,c=document.createElement("div");c.dataset.tooltip=game.i18n.localize(r),c.id="crlngn-folder-toggle",c.innerHTML="<i class='fa-solid icon'></i>",c.addEventListener("click",()=>{P.setNavPosition(0);const d=!P.navShowRootFolders;E.set(a.navShowRootFolders.tag,d),P.placeNavButtons()}),s==null||s.append(c),P.navShowRootFolders?s==null||s.classList.add("with-folders"):s==null||s.classList.remove("with-folders")}static toggleFolderLookup(e){const t=e.target.parentNode;t.classList.contains("open")?t.classList.remove("open"):t.classList.add("open")}static buildTemplateData(e){if(!e||!ui.scenes)return{};const t=ui.scenes.collection.folders;let n={},a=[],o=e.contents?[...e.contents]:[];return o=o.filter(s=>s.permission>=2),k(N,We,game.scenes.sortingMode),f.log("buildFolderData A",[e.name,e]),e.id===Yn?a=t.filter(s=>s.folder===null)||[]:a=e.children,a=N.sortFolderList(a),n={currentFolder:e,folders:a,scenes:o},f.log("buildFolderData",[a,n]),n}static sortFolderList(e){return e=e.map((t,n)=>t.folder?t.folder:t),m(N,We)==="a"?e.sort((t,n)=>t.name.toLowerCase().localeCompare(n.name.toLowerCase())):e.sort((t,n)=>t.sort-n.sort),e}};We=new WeakMap,_=new WeakMap,Fn=new WeakMap,Dn=new WeakSet,Va=function(){try{if(game.scenes&&game.scenes.sortingMode!==void 0){k(N,We,game.scenes.sortingMode);return}}catch(e){console.error("Error checking scene directory sort mode:",e)}k(N,We,"a"),f.log("updateSortMode fallback",[m(N,We)])},T(N,Dn),h(N,"selectedFolder",Yn),T(N,We,"a"),T(N,_,[]),h(N,"searchValue",""),h(N,"renderFolderList",async e=>{k(N,_,game.user.getFlag(z,"activeSceneFolders")||[]);let t;const n=ui.scenes.collection.folders,a=e?n.get(e.dataset.folderId):{name:"",id:Yn},o=N.buildTemplateData(a),s=await R.renderTemplate(`modules/${z}/templates/scene-nav-folders.hbs`,o);e?t=e.parentNode:t=document.querySelector("#scene-navigation-inactive"),t.insertAdjacentHTML("afterbegin",s);const r=t.querySelectorAll("li.folder");N.addFolderListeners(r),P.placeNavButtons()}),h(N,"handleFolderLookup",async()=>{const e=await R.renderTemplate(`modules/${z}/templates/scene-nav-lookup.hbs`,{}),t=document.querySelector("#crlngn-lookup-list");t&&t.remove();const n=document.querySelector("#crlngn-scene-lookup");n.insertAdjacentHTML("beforeend",e);const a=n.querySelector(".search-container .input-scene-search");a.addEventListener("keyup",N.onSearchInput),a.addEventListener("keydown",s=>{s.stopPropagation()});const o=n==null?void 0:n.querySelector(".scene-lookup-toggle");o&&o.addEventListener("click",N.toggleFolderLookup)}),h(N,"addFolderListeners",e=>{const t=ui.scenes.collection.folders;e&&e.forEach(n=>{n.querySelector(".folder-item").addEventListener("click",m(N,Fn));const a=n.dataset.folderId,o=t.get(a),s=m(N,_).includes(a);f.log("addFolderListeners isActive",[s,a,o.name]),s&&(n.classList.add("crlngn-folder-active"),N.injectSubfolders(o,n))})}),T(N,Fn,async e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget;t.offsetLeft,t.parentNode.parentNode.querySelectorAll(".crlngn-folder-active");const n=t.dataset.folderId||t.parentNode.dataset.folderId,a=ui.scenes.collection.folders,o=n?a.get(n):null;if(!o)return;await N.injectSubfolders(o,t.parentNode),P.addSceneListeners(t.parentNode),f.log("onNavFolderClick",[t,t.parentNode,t.parentNode.dataset]),t.classList.contains("crlngn-folder-active")||t.parentNode.classList.contains("crlngn-folder-active")?N.updateActiveFolders(n,!0):N.updateActiveFolders(n,!1)}),h(N,"injectSubfolders",async(e,t)=>{const n=N.buildTemplateData(e),a=await R.renderTemplate(`modules/${z}/templates/scene-nav-subfolders.hbs`,n),o=t.querySelector(".contents");o&&o.remove(),t.insertAdjacentHTML("beforeend",a);const s=t.querySelectorAll("li.folder");N.addFolderListeners(s),P.addSceneListeners(t.querySelector(".contents"))}),h(N,"updateActiveFolders",async(e,t=!1)=>{const n=document.querySelector("#scene-navigation-inactive"),a=n==null?void 0:n.querySelector(`li.folder[data-folder-id="${e}"]`),o=m(N,_).indexOf(e);f.log("updateActiveFolders A",[o,e,game.user.getFlag(z,"activeSceneFolders"),m(N,_)]),t?(k(N,_,m(N,_).filter(s=>s!==e)),a.classList.remove("crlngn-folder-active")):m(N,_).includes(e)||(a.parentNode.querySelectorAll("li.folder").forEach(r=>{r!==a&&(k(N,_,m(N,_).filter(c=>c!==r.dataset.folderId)),r.classList.remove("crlngn-folder-active"))}),m(N,_).push(e),a.classList.add("crlngn-folder-active")),await game.user.setFlag(z,"activeSceneFolders",m(N,_)),f.log("updateActiveFolders B",[t,e,game.user.getFlag(z,"activeSceneFolders"),m(N,_)])}),h(N,"selectFolder",e=>N.getFolderById(e)||null),h(N,"noFolderView",()=>{var t;return!((t=game==null?void 0:game.user)==null?void 0:t.isGM)&&!P.navFoldersForPlayers||!P.useSceneFolders||!P.sceneNavEnabled}),h(N,"preloadTemplates",async()=>{const e=[`modules/${z}/templates/scene-nav-folders.hbs`,`modules/${z}/templates/scene-nav-subfolders.hbs`,`modules/${z}/templates/scene-nav-lookup.hbs`];return await loadTemplates(e),!0}),h(N,"onSearchInput",e=>{e.stopPropagation();const n=e.currentTarget.value;N.searchValue=n,N.updateSearchResults(n)}),h(N,"updateSearchResults",e=>{var o,s;if(!P.useSceneLookup)return;const t=document.querySelector("#crlngn-scene-lookup .search-container .search-results");if(!t)return;if(t.innerHTML="",!e){t.classList.add("hidden");return}const n=((o=game.scenes)==null?void 0:o.filter(r=>r.name.toLowerCase().includes(e.toLowerCase())&&r.permission>=2))||[];n.sort((r,c)=>r.name.toLowerCase().localeCompare(c.name.toLowerCase()));let a=[];if(P.useSceneFolders&&(a=((s=game.scenes)==null?void 0:s.folders.filter(r=>r.name.toLowerCase().includes(e.toLowerCase())))||[],a.sort((r,c)=>r.name.toLowerCase().localeCompare(c.name.toLowerCase())),a.forEach(r=>{const c=document.createElement("li");c.className="search-folder",c.dataset.folderId=r.id,c.innerHTML=`<a><i class="fas fa-folder"></i> ${r.name}</a>`,c.addEventListener("click",N.onSelectSearchedFolder),t.appendChild(c)})),t.classList.remove("hidden"),n.forEach(r=>{const c=document.createElement("li");c.className="search-scene",c.dataset.sceneId=r.id,c.innerHTML=`<a><i class="fas fa-map"></i> ${r.name}</a>`,c.addEventListener("dblclick",P.onActivateScene),c.addEventListener("click",P.onSelectScene),t.appendChild(c)}),a.length===0&&n.length===0){const r=document.createElement("li");r.className="no-results",r.textContent="No matching results found",t.appendChild(r)}}),h(N,"onSelectSearchedFolder",async e=>{e.stopPropagation(),e.preventDefault();const n=e.currentTarget.dataset.folderId,a=document.querySelector("#crlngn-folder-toggle");if(P.navShowRootFolders||a.click(),!n)return;const r=[...ui.scenes.collection.folders.get(n).ancestors];k(N,_,[]);for(const c of r)m(N,_).push(c.id);m(N,_).push(n),await game.user.setFlag(z,"activeSceneFolders",m(N,_)),setTimeout(async()=>{ui.nav.render()},200)});let Qe=N;var ue,ja,Ya,$a,mn,Xa;const J=class J{static init(){const e=w();f.log("SheetsUtil.init",[]),game.system.id==="dnd5e"&&(J.themeStylesEnabled=E.get(e.applyThemeToSheets.tag),J.horizontalSheetTabsEnabled=E.get(e.useHorizontalSheetTabs.tag),Hooks.on(A.RENDER_ACTOR_SHEET,ne(J,ue,ja)),Hooks.on(A.RENDER_COMPENDIUM_BROWSER,ne(J,ue,Ya)))}static applyThemeToSheets(e){J.themeStylesEnabled=e,e?document.body.classList.add("crlngn-sheets"):document.body.classList.remove("crlngn-sheets")}static applyHorizontalSheetTabs(e){var t,n;J.horizontalSheetTabsEnabled=e,e?(document.body.classList.add("crlngn-sheet-tabs"),ne(t=J,ue,mn).call(t)):(document.body.classList.remove("crlngn-sheet-tabs"),ne(n=J,ue,Xa).call(n))}};ue=new WeakSet,ja=function(e,t,n){var o;f.log(A.RENDER_ACTOR_SHEET,[e,t.querySelector(".sheet-body"),n]),(o=t.querySelector(".sheet-body .main-content"))==null||o.addEventListener("scroll",ne(J,ue,$a));const a=t.querySelectorAll("nav.tabs > a.item");for(const s of a)s.removeAttribute("data-tooltip"),s.removeAttribute("data-tooltip-delay");J.applyThemeToSheets(J.themeStylesEnabled),J.applyHorizontalSheetTabs(J.horizontalSheetTabsEnabled),J.horizontalSheetTabsEnabled&&setTimeout(()=>{var s;ne(s=J,ue,mn).call(s)},100)},Ya=function(e,t,n){f.log(A.RENDER_COMPENDIUM_BROWSER,[e,t,n]),J.horizontalSheetTabsEnabled&&setTimeout(()=>{var a;ne(a=J,ue,mn).call(a)},100)},$a=function(e){const t=e.target.closest(".window-content"),n=t==null?void 0:t.querySelector(".ability-scores");n&&(e.target.scrollTop>30?n.classList.add("fadeout"):n.classList.remove("fadeout"))},mn=function(){document.querySelectorAll(".dnd5e2.vertical-tabs nav.tabs").forEach(t=>{const n=t.parentElement;if(n.querySelector(".crlngn-tab-scroll-btn"))return;const a=document.createElement("div");a.className="crlngn-tab-scroll-wrapper";const o=document.createElement("button");o.className="crlngn-tab-scroll-btn crlngn-tab-scroll-prev",o.innerHTML='<i class="fas fa-caret-left"></i>',o.addEventListener("click",r=>{r.preventDefault(),t.scrollBy({left:-150,behavior:"smooth"})});const s=document.createElement("button");s.className="crlngn-tab-scroll-btn crlngn-tab-scroll-next",s.innerHTML='<i class="fas fa-caret-right"></i>',s.addEventListener("click",r=>{r.preventDefault(),t.scrollBy({left:150,behavior:"smooth"})}),n.insertBefore(a,t),a.appendChild(o),a.appendChild(t),a.appendChild(s)})},Xa=function(){document.querySelectorAll(".crlngn-tab-scroll-wrapper").forEach(t=>{const n=t.querySelector("nav.tabs");n&&t.parentElement&&(t.parentElement.insertBefore(n,t),t.remove())})},T(J,ue),h(J,"themeStylesEnabled",!0),h(J,"horizontalSheetTabsEnabled",!0);let _e=J;const x=class x{static init(){Hooks.on(A.RENDER_SIDE_BAR,x.onRender)}static applyFadeOut(e){x.useFadeOut=e,x.handleFadeOut()}static applyHide(e){x.hidden=e,x.handleHide()}static handleHide(e,t,n){var o;const a=t?t.querySelector("#sidebar-tabs"):document.querySelector("#sidebar-tabs");x.hidden?(o=game.user)!=null&&o.isGM||a==null||a.classList.add("hidden-ui"):a==null||a.classList.remove("hidden-ui"),f.log("handle Hide",[x.hidden])}static applyCustomStyle(e){var t;x.customStylesEnabled=e,f.log("applyCustomStyle",[x.customStylesEnabled]),(t=ui.sidebar)==null||t.render()}static applyFolderStyles(e){x.folderStylesEnabled=e,x.folderStylesEnabled?document.querySelector("body").classList.add("crlngn-folder-style"):document.querySelector("body").classList.remove("crlngn-folder-style"),f.log("applyFolderStyles",[x.folderStylesEnabled])}static onRender(e,t,n){var a,o;x.handleClassApplication(),x.handleFadeOut(e,t,n),x.handleHide(e,t,n),x.applyFolderStyles(x.folderStylesEnabled),f.log("SidebarTabs onRender",[(o=(a=foundry.applications)==null?void 0:a.sidebar)==null?void 0:o.tabs])}static handleClassApplication(){x.customStylesEnabled?document.querySelector("body").classList.add("crlngn-tabs"):document.querySelector("body").classList.remove("crlngn-tabs")}static handleFadeOut(e,t,n){const a=t?t.querySelector("#sidebar-tabs"):document.querySelector("#sidebar-tabs");x.useFadeOut?a==null||a.classList.add("faded-ui"):a==null||a.classList.remove("faded-ui"),f.log("SidebarTabs handle fade out",[x.useFadeOut])}};h(x,"useFadeOut",!0),h(x,"hidden",!1),h(x,"customStylesEnabled",!0),h(x,"folderStylesEnabled",!0),h(x,"applySideBarWidth",()=>{const e=w(),t=E.get(e.sideBarWidth.tag)||300;R.addCSSVars("--sidebar-width",`${t}px`)});let He=x;var bt;const b=class b{static get(e,t=z){if(!e)return null;let n=!1;if(t===z)n=game.settings.get(t,e);else{let o=game.settings.storage.get("client")[`${t}.${e}`];o===void 0&&(o=game.settings.storage.get("world").getSetting(`${t}.${e}`)),n=o==null?void 0:o.value,f.log("GET Setting",[o,n])}return n}static set(e,t,n=z){if(!e)return!1;let a=game.settings.storage.get("client")[`${n}.${e}`];a||(a=game.settings.storage.get("world").getSetting(`${n}.${e}`)),f.log("Setting",[e,a,t]);try{game.settings.set(n,e,t)}catch{f.log("Unable to change setting",[e,a])}return!0}static apply(e,t=void 0){var a,o,s,r,c,d,g,p,y,C,L,O,$,te;const n=w();switch(t===void 0&&(t=b.get(e)),f.log("SettingsUtil.apply",[e,t,b.get(e)]),e){case n.disableUI.tag:location.reload();break;case n.enableMacroLayout.tag:Te.applyCustomStyle(t);break;case n.collapseMacroBar.tag:Te.applyHotBarCollapse();break;case n.playerListAvatars.tag:Se.applyAvatars();break;case n.autoHidePlayerList.tag:Se.applyPlayersListSettings();break;case n.uiFontBody.tag:case n.uiFontTitles.tag:case n.journalFontBody.tag:case n.journalFontTitles.tag:b.applyCustomFonts(e,t);break;case n.controlsAutoHide.tag:b.applyLeftControlsSettings(e,t);break;case n.dockHeight.tag:ee.currSettings.dockHeight=t,b.applyCameraHeight(t);break;case n.dockWidth.tag:ee.currSettings.dockWidth=t,b.applyCameraWidth(t);break;case n.dockPosX.tag:ee.currSettings.dockPosX=t,b.applyCameraPosX(t);break;case n.dockPosY.tag:ee.currSettings.dockPosY=t,b.applyCameraPosY(t);break;case n.defaultVideoWidth.tag:ee.currSettings.defaultVideoWidth=t,ee.applyVideoWidth(t);break;case n.dockResizeOnUserJoin.tag:ee.currSettings.dockResizeOnUserJoin=t,ee.applyDockResize(t);break;case n.chatBorderColor.tag:it.chatBorderColor=t,b.applyBorderColors();break;case n.sideBarWidth.tag:P.sideBarWidth=t,He.applySideBarWidth();break;case n.useLeftChatBorder.tag:it.useLeftChatBorder=t;case n.enableChatStyles.tag:it.enableChatStyles=t,b.applyChatStyles();break;case n.debugMode.tag:b.applyDebugSettings();break;case n.useSceneFolders.tag:P.useSceneFolders=t,(a=ui.nav)==null||a.render();break;case n.navShowRootFolders.tag:P.navShowRootFolders=t,(o=ui.nav)==null||o.render();break;case n.hideInactiveOnFolderToggle.tag:P.hideInactiveOnFolderToggle=t,(s=ui.nav)==null||s.render();break;case n.sceneClickToView.tag:P.sceneClickToView=t,(r=ui.nav)==null||r.render(),(d=(c=game.scenes)==null?void 0:c.directory)==null||d.render();break;case n.useSceneIcons.tag:P.useSceneIcons=t,(g=ui.nav)==null||g.render(),(y=(p=game.scenes)==null?void 0:p.directory)==null||y.render();break;case n.useSceneBackButton.tag:P.useSceneBackButton=t,(C=ui.nav)==null||C.render();break;case n.useSceneLookup.tag:P.useSceneLookup=t,(L=ui.nav)==null||L.render();break;case n.useScenePreview.tag:P.useScenePreview=t,(O=ui.nav)==null||O.render();break;case n.sceneItemWidth.tag:P.sceneItemWidth=t,P.applySceneItemWidth();break;case n.navStartCollapsed.tag:P.navStartCollapsed=t,($=ui.nav)==null||$.render();break;case n.showNavOnHover.tag:P.showNavOnHover=t;break;case n.sceneNavCollapsed.tag:P.isCollapsed=b.get(n.sceneNavCollapsed.tag);break;case n.colorTheme.tag:b.applyThemeSettings();break;case n.customStyles.tag:b.applyCustomCSS(t);break;case n.forcedDarkTheme.tag:b.applyForcedDarkTheme(t);break;case n.adjustOtherModules.tag:b.applyModuleAdjustments(t);break;case n.otherModulesList.tag:b.applyOtherModulesList(t);break;case n.enablePlayerList.tag:Se.applyCustomStyle(t);break;case n.sceneNavEnabled.tag:P.applyCustomStyle(t);break;case n.enableMacroLayout.tag:Te.applyCustomStyle(t);break;case n.enableFloatingDock.tag:ee.applyCustomStyle(t);break;case n.enableSidebarTabs.tag:He.applyCustomStyle(t);break;case n.enableChatLogControls.tag:gt.applyCustomStyle(t);break;case n.enableSceneControls.tag:ut.applyCustomStyle(t);break;case n.sceneControlsFadeOut.tag:ut.applyFadeOut(t);break;case n.playerListFadeOut.tag:Se.applyFadeOut(t);break;case n.sidebarTabsFadeOut.tag:He.applyFadeOut(t);break;case n.cameraDockFadeOut.tag:ee.applyFadeOut(t);break;case n.macroHotbarFadeOut.tag:Te.applyFadeOut(t);break;case n.chatLogControlsFadeOut.tag:gt.applyFadeOut(t);break;case n.sceneNavFadeOut.tag:P.applyFadeOut(t);break;case n.sceneControlsHide.tag:ut.applyHide(t);break;case n.playerListHide.tag:Se.applyHide(t);break;case n.sidebarTabsHide.tag:He.applyHide(t);break;case n.cameraDockHide.tag:ee.applyHide(t);break;case n.macroHotbarHide.tag:Te.applyHide(t);break;case n.chatLogControlsHide.tag:gt.applyHide(t);break;case n.sceneNavHide.tag:P.applyHide(t);break;case n.useFolderStyle.tag:He.applyFolderStyles(t);break;case n.applyThemeToSheets.tag:_e.applyThemeToSheets(t);break;case n.useHorizontalSheetTabs.tag:_e.applyHorizontalSheetTabs(t);break;case n.enforceGMSettings.tag:t&&((te=game.user)!=null&&te.isGM)&&(b.saveDefaultSettings(),ui.notifications.info("Current settings saved as defaults for players"));break}}static applyBorderColors(){const e=w(),t=b.get(e.chatBorderColor.tag),n=document.querySelector("body");t===St.playerColor.name?(n.classList.add("player-chat-borders"),n.classList.remove("roll-chat-borders")):t===St.rollType.name?(n.classList.add("roll-chat-borders"),n.classList.remove("player-chat-borders")):(n.classList.remove("player-chat-borders"),n.classList.remove("roll-chat-borders"))}static applyChatStyles(){const e=w(),t=b.get(e.enableChatStyles.tag),n=document.querySelector("body");f.log("applyChatStyles",[t,e]),t?n.classList.add("crlngn-chat"):n.classList.remove("crlngn-chat")}static applyLeftControlsSettings(e,t){const n=w();b.get(n.sceneNavEnabled.tag);const a=document.querySelector("#ui-left");switch(document.querySelector("body.crlngn-ui"),document.querySelector("#crlngn-ui-vars"),f.log("applyLeftControlsSettings",[e]),e){case n.controlsAutoHide.tag:b.get(n.controlsAutoHide.tag)?a.classList.add("auto-hide"):a.classList.remove("auto-hide");break}}static applyControlIconSize(){const e=w(),t=b.get(e.controlsIconSize.tag);document.querySelector("body");const n=Rt[t]?Rt[t].size:Rt.regular.size;function a(o){switch(o){case Rt.large.name:return"var(--font-size-18);";case Rt.regular.name:return"var(--font-size-16);";default:return"var(--font-size-14);"}}f.log("applyControlIconSize",[n]),R.addCSSVars("--icon-font-size",a(t)),R.addCSSVars("--control-item-size",n),b.applyLeftControlsSettings()}static applySceneNavPos(e){const t=w();P.navPos=e||b.get(t.sceneNavPos.tag)}static applyCameraPosX(e){const t=w(),n=b.get(t.dockPosX.tag),a=e||n;ee.resetPositionAndSize({x:a})}static applyCameraPosY(e){const t=w(),n=b.get(t.dockPosY.tag),a=e||n;ee.resetPositionAndSize({y:a})}static applyCameraWidth(e){const t=w(),n=b.get(t.dockWidth.tag),a=e||n;ee.resetPositionAndSize({w:a})}static applyCameraHeight(e){const t=w(),n=b.get(t.dockHeight.tag),a=e||n;ee.resetPositionAndSize({h:a})}static applyCustomFonts(e,t){const n=w(),a=n.customFontsMenu.fields,o={};switch(f.log("applyCustomFonts",[e,t]),a.forEach(s=>{o[s]=b.get(n[s].tag)}),document.querySelector("body.crlngn-ui"),e){case n.uiFontBody.tag:R.addCSSVars("--crlngn-font-family",t||o.uiFontBody||n.uiFontBody.default.uiFont||"");break;case n.uiFontTitles.tag:R.addCSSVars("--crlngn-font-titles",t||o.uiFontTitles||n.uiFontTitles.default.uiTitles||"");break;case n.journalFontBody.tag:R.addCSSVars("--crlngn-font-journal-body",t||o.journalFontBody||o.journalFontBody||"");break;case n.journalFontTitles.tag:R.addCSSVars("--crlngn-font-journal-title",t||o.journalFontTitles||o.journalFontTitles||"");break}}static resetFoundryThemeSettings(){}static applyDebugSettings(e){const t=w();f.debugOn=e||b.get(t.debugMode.tag)}static enforceGMSettings(){var a;const e=w();if((a=game.user)!=null&&a.isGM||!b.get(e.enforceGMSettings.tag))return;const t=b.get(e.defaultSettings.tag);if(!t||Object.keys(t).length<=1){f.log("No default GM settings found to enforce");return}f.log("Enforcing GM settings to player",[t]);let n=!1;for(const[o,s]of Object.entries(t))if(o!=="_version")try{const r=Object.values(e).find(c=>c.tag===o);r&&r.scope==="client"&&b.get(o)!==s&&(b.set(o,s),f.log(`Applied GM setting: ${o}`,[s]),n=!0)}catch(r){f.log(`Failed to apply GM setting: ${o}`,[r])}return n}static saveDefaultSettings(){var n;const e=w();if(!((n=game.user)!=null&&n.isGM)||!b.get(e.enforceGMSettings.tag))return;const t={_version:Date.now()};for(const[a,o]of Object.entries(e))if(o.tag&&o.scope==="client"&&!o.isMenu){const s=b.get(o.tag);s!==void 0&&(t[o.tag]=s)}b.set(e.defaultSettings.tag,t),f.log("Saved default GM settings",[t])}static onSettingChange(e){var n;const t=w();(n=game.user)!=null&&n.isGM&&b.get(t.enforceGMSettings.tag)&&b.saveDefaultSettings()}};bt=new WeakMap,T(b,bt,!1),h(b,"firstLoad",!0),h(b,"foundryUiConfig",null),h(b,"registerSettings",async()=>{const e=w();Object.entries(e).forEach(async g=>{const p=g[1];if(p.showOnRoot&&p.isMenu||!p.isMenu){const y={name:p.label,hint:p.hint,default:p.default,type:p.propType,scope:p.scope,config:p.config,requiresReload:p.requiresReload||!1,onChange:C=>{b.apply(p.tag,C),p.tag!=="v2-enforce-gm-settings"&&p.tag!=="v2-default-settings"&&b.onSettingChange(p.tag)}};(p.choices||p.options)&&(y.choices=p.choices||p.options),await game.settings.register(z,p.tag,y),b.get(p.tag)===void 0&&(f.log("resetting...",[p.tag]),b.set(p.tag,p.default))}}),game.keybindings.register(z,"hideInterface",{name:game.i18n.localize("CRLNGN_UI.settings.hideInterface.label"),hint:game.i18n.localize("CRLNGN_UI.settings.hideInterface.hint"),editable:[{key:"0",modifiers:["Control"]}],onDown:()=>{},onUp:()=>{b.hideInterface()},restricted:!1}),b.applyThemeSettings(),b.applyCustomCSS(),b.applyModuleAdjustments();const a=Object.entries(ka()).find(g=>g[0]==="moduleSettingsMenu");if(a){const g=a[1],p={name:g.tag,label:g.label,hint:g.hint,icon:g.icon,type:g.propType,restricted:g.restricted};await game.settings.registerMenu(z,g.tag,p)}b.foundryUiConfig=game.settings.get("core","uiConfig")||null,Hooks.on(A.RENDER_SCENE_CONTROLS,b.applyLeftControlsSettings),Hooks.on(A.RENDER_PLAYERS_LIST,Se.applyPlayersListSettings),Hooks.on(A.RENDER_HOTBAR,()=>{Te.applyCustomStyle(),b.firstLoad&&(b.firstLoad=!1,Te.applyHotBarCollapse())}),b.applyDebugSettings(),b.applyChatStyles(),b.applyBorderColors(),_e.applyHorizontalSheetTabs(b.get(e.useHorizontalSheetTabs.tag)),_e.applyThemeToSheets(b.get(e.applyThemeToSheets.tag)),e.sceneNavMenu.fields.forEach(g=>{b.apply(e[g].tag)}),e.cameraDockMenu.fields.forEach(g=>{b.apply(e[g].tag)}),e.customFontsMenu.fields.forEach(g=>{b.applyCustomFonts(e[g].tag)}),e.leftControlsMenu.fields.forEach(g=>{b.applyLeftControlsSettings(e[g].tag)}),e.interfaceOptionsMenu.fields.forEach(g=>{b.apply(e[g].tag)}),b.applyForcedDarkTheme()}),h(b,"applyThemeSettings",e=>{const t=w(),n=e||b.get(t.colorTheme.tag)||"",a=document.querySelector("body");f.log("applyThemeSettings",[e,n,b.get(t.colorTheme.tag)]),Ke.forEach(o=>{o.className&&a.classList.remove(o.className)}),n&&a.classList.add(n)}),h(b,"applyCustomCSS",e=>{const t=w(),n=e||b.get(t.customStyles.tag)||"";R.addCustomCSS(n)}),h(b,"applyForcedDarkTheme",e=>{var s,r,c,d;if(!(((r=(s=b.foundryUiConfig)==null?void 0:s.colorScheme)==null?void 0:r.applications)==="dark"||((d=(c=b.foundryUiConfig)==null?void 0:c.colorScheme)==null?void 0:d.interface)==="dark"))return;const n=w();let o=(e||b.get(n.forcedDarkTheme.tag)||"")+" {"+_a+"}";f.log("applyForcedDarkTheme",[b.foundryUiConfig]),R.isValidCSSRule(o)&&R.addCustomCSS(o,"crlngn-forced-dark-mode")}),h(b,"applyModuleAdjustments",e=>{const t=w();(e||b.get(t.adjustOtherModules.tag)||!1)&&vt.addModuleClasses()}),h(b,"applyOtherModulesList",e=>{const t=w(),n=e||b.get(t.otherModulesList.tag);f.log("applyOtherModulesList",[n]),n.split(",").length===0?(b.set(t.adjustOtherModules.tag,!1),b.set(t.otherModulesList.tag,"")):b.set(t.adjustOtherModules.tag,!0),vt.addModuleClasses()}),h(b,"hideInterface",()=>{f.log("hideInterface");const e=document.querySelector("#interface"),t=document.querySelector("#camera-views"),n=document.querySelector(".taskbar");m(b,bt)?(e&&e.style.removeProperty("visibility"),e&&t.style.removeProperty("visibility"),e&&n.style.removeProperty("visibility"),k(b,bt,!1)):(e&&e.style.setProperty("visibility","hidden"),t&&t.style.setProperty("visibility","hidden"),n&&n.style.setProperty("visibility","hidden"),k(b,bt,!0))});let E=b;const zt=class zt{static getUpdateNewsUrl(){var n;const e=(n=game.modules.get("crlngn-ui"))==null?void 0:n.version,t=e?`https://github.com/crlngn/crlngn-ui/releases/download/v${e}/module-updates.json`:"";return`https://proxy.carolingian.io/proxy?url=${encodeURIComponent(t)}&v=${e}`}static init(){var e;(e=game.user)!=null&&e.isGM&&this.checkForUpdates()}static cleanSetting(){const e=w();E.set(e.lastUpdateId.tag,"")}static async checkForUpdates(){const e=w();try{const t=new AbortController,n=setTimeout(()=>t.abort(),1e4);try{const a=await E.get(e.lastUpdateId.tag),o=await zt.getIdFromRawJson();if(f.log("checkForUpdates...",[o,a]),a===o)return;const s=await fetch(zt.getUpdateNewsUrl(),{signal:t.signal,mode:"cors",credentials:"omit"});if(clearTimeout(n),!s.ok){f.warn("checkForUpdates | Failed to fetch update news",[s.status,s.statusText]);return}const r=await s.json();await this.displayUpdateNews(r),E.set(e.lastUpdateId.tag,r.id),f.log("checkForUpdates | SUCCESS",[r.id])}catch(a){clearTimeout(n),a.name==="AbortError"?f.warn("checkForUpdates | Request timed out",[a]):f.warn("checkForUpdates | Fetch error",[a.message])}}catch(t){f.warn("checkForUpdates | Unexpected error",[t])}}static async displayUpdateNews(e){try{const t=`
        <div class="crlngn-news">
          <h3>${e.title}</h3>
          ${e.imageUrl?`<img src="${e.imageUrl}" alt="Update Preview" />`:""}
          ${e.videoUrl?`<div class="updates-media-container"><video controls autoplay loop src="${e.videoUrl}" alt="Update Preview" style="width: 100%"></video></div>`:""}
          <div class="crlngn-news-content">
          ${e.content}
          </div>
        </div>
      `;f.error("displayUpdateNews | Chat message created",[e]);const n=await ChatMessage.create({content:t,whisper:[game.user.id],speaker:{alias:"Carolingian UI"}});f.error("displayUpdateNews | Chat message created",[n,e])}catch(t){f.error("displayUpdateNews | Error creating chat message",[t])}}};h(zt,"getIdFromRawJson",async()=>{const t=await fetch("https://raw.githubusercontent.com/crlngn/crlngn-ui/refs/heads/v2/news/module-updates.json"),n=t.ok?await t.json():null;return n&&n.id||""});let ea=zt;class Io{static init(){Handlebars.registerHelper("normalizedIncludes",function(e,t){return f.log("CustomHandlebarsHelpers",[e,t,e==null?void 0:e.includes(t)]),e==null?void 0:e.includes(t)})}}var Mn;const ze=class ze{static init(){Hooks.once(A.INIT,()=>{var o,s;if(document.querySelector("body").classList.add(z),(o=document.querySelector("#ui-middle"))==null||o.classList.add(z),game.data.version<"13.339"){ze.isIncompatible=!0;return}f.log("Initiating module...",[],!0),window.crlngnUI=window.crlngnUI||{},E.registerSettings();const n=w(),a=E.get(n.disableUI.tag);if(f.log(A.INIT,[a]),a){document.querySelector("body").classList.remove(z),(s=document.querySelector("#ui-middle"))==null||s.classList.remove(z);return}Se.init(),P.init(),ee.init(),ut.init(),gt.init(),it.init(),He.init(),Te.init(),Hooks.on(A.RENDER_CHAT_MESSAGE,m(ze,Mn))}),Hooks.once(A.READY,()=>{var o;if(f.log("Core Ready",[game]),ze.isIncompatible){ui.notifications.error(game.i18n.localize("CRLNGN_UI.notifications.incompatibleVersion"),{permanent:!0});return}const e=w();var t=E.get(e.debugMode.tag);t&&(CONFIG.debug.hooks=!0),Io.init(),P.checkSideBar(((o=ui.sidebar)==null?void 0:o.expanded)||!1),E.enforceGMSettings()&&P.refreshSettings(),Se.applyPlayersListSettings(),vt.init(),ea.init(),_e.init(),E.get(e.enableChatStyles.tag)&&ze.addCSSLocalization(),setTimeout(()=>{var s;(s=ui.combat.popout)==null||s.close()},200)})}static addCSSLocalization(){const e="CRLNGN_UI.dnd5e.chatCard.buttons";R.addCSSVars("--crlngn-i18n-attack",game.i18n.localize(`${e}.attack`)),R.addCSSVars("--crlngn-i18n-damage",game.i18n.localize(`${e}.damage`)),R.addCSSVars("--crlngn-i18n-summons",game.i18n.localize(`${e}.summons`)),R.addCSSVars("--crlngn-i18n-healing",game.i18n.localize(`${e}.healing`)),R.addCSSVars("--crlngn-i18n-template",game.i18n.localize(`${e}.template`)),R.addCSSVars("--crlngn-i18n-consume",game.i18n.localize(`${e}.consume`)),R.addCSSVars("--crlngn-i18n-refund",game.i18n.localize(`${e}.refund`)),R.addCSSVars("--crlngn-i18n-macro",game.i18n.localize(`${e}.macro`)),R.addCSSVars("--crlngn-i18n-save-dc",game.i18n.localize(`${e}.savedc`)),R.addCSSVars("--crlngn-i18n-save",game.i18n.localize(`${e}.save`))}};Mn=new WeakMap,h(ze,"isIncompatible",!1),T(ze,Mn,(e,t,n)=>{f.log(A.RENDER_CHAT_MESSAGE,[e,t,n]),it.enrichCard(e,t)});let ta=ze;ta.init();
//# sourceMappingURL=crlngn-ui.js.map
